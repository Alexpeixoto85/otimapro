<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ótica VisionPlus - Sistema Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f5f7fa; color: #333; line-height: 1.6; }
        
        /* Layout Geral */
        .container { display: flex; flex-direction: column; min-height: 100vh; }
        
        /* Login */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); }
        .login-box { background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); width: 100%; max-width: 400px; padding: 2rem; text-align: center; }

        /* Header */
        header { background-color: var(--primary-color); color: white; padding: 1rem; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; }
        .logo-container { display: flex; align-items: center; gap: 15px; }
        .logo-img { max-height: 50px; border-radius: 4px; background: white; padding: 2px; }
        
        /* Nav */
        nav { background-color: var(--secondary-color); padding: 0.5rem; position: sticky; top: 0; z-index: 100; }
        .nav-menu { display: flex; list-style: none; gap: 5px; flex-wrap: wrap; justify-content: center; }
        .nav-menu a { color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: var(--border-radius); display: flex; align-items: center; gap: 8px; transition: 0.3s; font-size: 0.9rem; }
        .nav-menu a:hover, .nav-menu a.active { background-color: rgba(255,255,255,0.2); font-weight: bold; }

        /* Conteúdo */
        main { flex: 1; padding: 1.5rem; max-width: 1400px; margin: 0 auto; width: 100%; }
        .page { display: none; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .page-title { color: var(--primary-color); font-size: 1.6rem; }

        /* Cards e Dashboard */
        .cards-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: white; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); border-left: 5px solid var(--secondary-color); position: relative; overflow: hidden; }
        .card-value { font-size: 1.8rem; font-weight: bold; color: var(--secondary-color); margin-top: 10px; }
        .card-alert { border-left-color: var(--accent-color); }
        .card-alert .card-value { color: var(--accent-color); }
        .card-info { border-left-color: var(--warning-color); }

        /* Tabelas */
        .table-responsive { overflow-x: auto; background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: var(--primary-color); font-weight: 600; }
        tr:hover { background-color: #f1f1f1; }
        .prod-thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }

        /* Badges de Status */
        .status { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .status-pendente { background: #fff3cd; color: #856404; }
        .status-concluido { background: #d4edda; color: #155724; }
        .status-cancelado { background: #f8d7da; color: #721c24; }

        /* Formulários e Botões */
        .form-container { background: white; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        .form-row { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
        .form-group { flex: 1; min-width: 200px; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: var(--border-radius); font-size: 1rem; }
        input:focus { border-color: var(--secondary-color); outline: none; }

        .btn { padding: 10px 15px; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; color: white; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background-color: var(--secondary-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-warning { background-color: var(--warning-color); }
        .btn-danger { background-color: var(--accent-color); }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: var(--border-radius); width: 100%; max-width: 800px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-header { padding: 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; }
        .modal-body { padding: 1.5rem; flex: 1; overflow-y: auto; }
        .modal-footer { padding: 1rem; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; background: #f8f9fa; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }

        /* Componentes Específicos */
        .image-upload-box { border: 2px dashed #ddd; height: 150px; display: flex; justify-content: center; align-items: center; cursor: pointer; border-radius: var(--border-radius); overflow: hidden; background: #fafafa; }
        .image-upload-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .payment-row { display: flex; gap: 10px; margin-bottom: 5px; align-items: center; background: #f9f9f9; padding: 5px; border-radius: 4px; }

        /* Dashboard Listas */
        .dash-list { list-style: none; margin-top: 10px; }
        .dash-list li { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .dash-list li:last-child { border-bottom: none; }
        .badge-alert { background: var(--accent-color); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }

        /* IMPRESSÃO TÉRMICA */
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            @page { margin: 0; size: auto; }
            .btn, .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="login-screen" class="login-container">
        <div class="login-box">
            <i class="fas fa-glasses fa-3x" style="color: var(--primary-color); margin-bottom: 10px;"></i>
            <h2>VisionPlus</h2>
            <p style="color: #666; margin-bottom: 20px;">Sistema de Gestão Ótica</p>
            <form id="login-form">
                <input type="text" id="login-user" placeholder="Usuário (admin)" required style="margin-bottom: 10px;">
                <input type="password" id="login-pass" placeholder="Senha (admin)" required style="margin-bottom: 15px;">
                <button type="submit" class="btn btn-primary" style="width: 100%;">ENTRAR</button>
            </form>
        </div>
    </div>

    <div id="app-container" class="container" style="display: none;">
        <header>
            <div class="logo-container">
                <img id="header-logo" class="logo-img" src="" alt="Logo" style="display: none;">
                <div>
                    <h2 id="store-name-display">Ótica VisionPlus</h2>
                    <small>Sistema Integrado v2.0</small>
                </div>
            </div>
            <div>
                <span id="user-display" style="margin-right: 15px;"><i class="fas fa-user"></i> Admin</span>
                <button class="btn btn-sm btn-danger" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
        </header>

        <nav>
            <ul class="nav-menu">
                <li><a href="#" class="nav-link active" data-page="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="#" class="nav-link" data-page="vendas"><i class="fas fa-shopping-cart"></i> PDV / Vendas</a></li>
                <li><a href="#" class="nav-link" data-page="orcamentos"><i class="fas fa-file-invoice-dollar"></i> Orçamentos</a></li>
                <li><a href="#" class="nav-link" data-page="clientes"><i class="fas fa-users"></i> Clientes</a></li>
                <li><a href="#" class="nav-link" data-page="produtos"><i class="fas fa-glasses"></i> Produtos</a></li>
                <li><a href="#" class="nav-link" data-page="config"><i class="fas fa-cog"></i> Configurações</a></li>
            </ul>
        </nav>

        <main>
            <section id="dashboard-page" class="page active">
                <div class="page-header">
                    <h2 class="page-title">Visão Geral</h2>
                    <button class="btn btn-primary" onclick="navTo('vendas'); openVendaModal();"><i class="fas fa-bolt"></i> Venda Rápida</button>
                </div>

                <div class="cards-container">
                    <div class="card">
                        <div class="card-title"><i class="fas fa-money-bill-wave"></i> Vendas Hoje</div>
                        <div class="card-value" id="dash-vendas-hoje">R$ 0,00</div>
                    </div>
                    <div class="card card-alert">
                        <div class="card-title"><i class="fas fa-exclamation-triangle"></i> Estoque Baixo</div>
                        <ul id="dash-estoque-baixo" class="dash-list">
                            <li>Carregando...</li>
                        </ul>
                    </div>
                    <div class="card card-info">
                        <div class="card-title"><i class="fas fa-birthday-cake"></i> Aniversariantes do Mês</div>
                        <ul id="dash-aniversariantes" class="dash-list">
                            <li>Carregando...</li>
                        </ul>
                    </div>
                </div>
            </section>

            <section id="produtos-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">Estoque e Produtos</h2>
                    <button class="btn btn-primary" onclick="openProdutoModal()"><i class="fas fa-plus"></i> Novo Produto</button>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Img</th>
                                <th>Cód. Barras</th>
                                <th>Produto</th>
                                <th>Estoque</th>
                                <th>Preço</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="produtos-list"></tbody>
                    </table>
                </div>
            </section>

            <section id="clientes-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">Clientes</h2>
                    <button class="btn btn-primary" onclick="openClienteModal()"><i class="fas fa-plus"></i> Novo Cliente</button>
                </div>
                <div class="form-container">
                    <input type="text" id="search-cliente" placeholder="Buscar por nome ou CPF..." onkeyup="filterClientes()">
                </div>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>Nome</th><th>Telefone</th><th>Nascimento</th><th>Ações</th></tr></thead>
                        <tbody id="clientes-list"></tbody>
                    </table>
                </div>
            </section>

            <section id="vendas-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">Histórico de Vendas</h2>
                    <button class="btn btn-primary" onclick="openVendaModal()"><i class="fas fa-plus"></i> Nova Venda</button>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>ID</th><th>Data</th><th>Cliente</th><th>Total</th><th>Ações</th></tr></thead>
                        <tbody id="vendas-list"></tbody>
                    </table>
                </div>
            </section>

            <section id="orcamentos-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">Orçamentos</h2>
                    <button class="btn btn-primary" onclick="openVendaModal(true)"><i class="fas fa-plus"></i> Novo Orçamento</button>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>ID</th><th>Data</th><th>Cliente</th><th>Valor</th><th>WhatsApp</th><th>Ações</th></tr></thead>
                        <tbody id="orcamentos-list"></tbody>
                    </table>
                </div>
            </section>

            <section id="config-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">Configurações da Loja</h2>
                    <button class="btn btn-success" onclick="salvarConfig()"><i class="fas fa-save"></i> Salvar Alterações</button>
                </div>
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nome da Loja</label>
                            <input type="text" id="conf-nome">
                        </div>
                        <div class="form-group">
                            <label>Telefone / WhatsApp</label>
                            <input type="text" id="conf-tel">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Endereço Completo</label>
                        <input type="text" id="conf-end">
                    </div>
                    <div class="form-group">
                        <label>Mensagem de Rodapé (Recibo)</label>
                        <input type="text" id="conf-msg" value="Obrigado pela preferência!">
                    </div>
                    <div class="form-group">
                        <label>Logo da Loja</label>
                        <div class="image-upload-box" onclick="document.getElementById('conf-logo-input').click()">
                            <img id="conf-logo-preview" src="" alt="Clique para carregar logo" style="display:none">
                            <span id="conf-logo-placeholder">Clique para carregar Logo</span>
                        </div>
                        <input type="file" id="conf-logo-input" hidden accept="image/*">
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="modal" id="modal-produto">
        <div class="modal-content">
            <div class="modal-header"><h3>Cadastro de Produto</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body">
                <form id="form-produto">
                    <input type="hidden" id="prod-id">
                    <div class="form-row">
                        <div class="form-group" style="flex: 0 0 150px;">
                            <label>Foto</label>
                            <div class="image-upload-box" style="height: 100px;" onclick="document.getElementById('prod-img-input').click()">
                                <img id="prod-img-preview" src="" style="display:none">
                                <span id="prod-img-text" style="font-size:0.8rem">Foto</span>
                            </div>
                            <input type="file" id="prod-img-input" hidden accept="image/*">
                        </div>
                        <div class="form-group">
                            <label>Nome do Produto</label>
                            <input type="text" id="prod-nome" required>
                            <label style="margin-top: 10px;">Código de Barras</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="text" id="prod-cod" placeholder="Escaneie ou digite">
                                <button type="button" class="btn btn-warning btn-sm" onclick="gerarCodigoBarras()">Gerar</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Categoria</label>
                            <select id="prod-cat">
                                <option value="Armacao">Armação</option>
                                <option value="Lente">Lente</option>
                                <option value="Solar">Solar</option>
                                <option value="Acessorio">Acessório</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Preço Venda</label><input type="number" step="0.01" id="prod-preco" required></div>
                        <div class="form-group"><label>Estoque Atual</label><input type="number" id="prod-qtd" required></div>
                        <div class="form-group"><label>Estoque Mínimo (Alerta)</label><input type="number" id="prod-min" value="3"></div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <svg id="barcode-preview"></svg>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="salvarProduto()">Salvar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-cliente">
        <div class="modal-content">
            <div class="modal-header"><h3>Cadastro de Cliente</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body">
                <form id="form-cliente">
                    <input type="hidden" id="cli-id">
                    <div class="form-row">
                        <div class="form-group"><label>Nome Completo</label><input type="text" id="cli-nome" required></div>
                        <div class="form-group"><label>CPF</label><input type="text" id="cli-cpf"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Telefone (WhatsApp)</label><input type="text" id="cli-tel" placeholder="Ex: 82999999999" required></div>
                        <div class="form-group"><label>Data Nascimento</label><input type="date" id="cli-nasc"></div>
                    </div>
                    <div class="form-group"><label>Receita / Observações</label><textarea id="cli-obs" rows="3"></textarea></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="salvarCliente()">Salvar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-venda">
        <div class="modal-content" style="max-width: 1000px; height: 95vh;">
            <div class="modal-header"><h3 id="venda-titulo">Nova Venda</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body" style="display: flex; flex-direction: column;">
                <div class="form-row" style="background: #f1f1f1; padding: 10px; border-radius: 5px;">
                    <div class="form-group">
                        <label>Cliente</label>
                        <select id="venda-cliente"></select>
                    </div>
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="venda-data">
                    </div>
                </div>

                <div style="margin: 15px 0; display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label style="font-weight: bold; color: var(--secondary-color);">LEITOR DE CÓDIGO DE BARRAS (Focar aqui)</label>
                        <input type="text" id="venda-search" placeholder="Bipe o produto ou digite o nome e aperte ENTER..." 
                               style="font-size: 1.2rem; border: 2px solid var(--secondary-color);" autocomplete="off">
                    </div>
                    <div style="width: 100px;">
                        <label>Qtd</label>
                        <input type="number" id="venda-qtd-add" value="1" min="1" style="height: 48px;">
                    </div>
                </div>

                <div style="flex: 1; overflow-y: auto; border: 1px solid #eee; margin-bottom: 15px;">
                    <table class="table-striped">
                        <thead><tr><th>Item</th><th>Qtd</th><th>Unit.</th><th>Total</th><th>X</th></tr></thead>
                        <tbody id="venda-itens"></tbody>
                    </table>
                </div>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Desconto (R$)</label>
                            <input type="number" id="venda-desc" value="0" step="0.01" onchange="renderCarrinho()">
                        </div>
                        <div class="form-group" style="text-align: right;">
                            <div style="font-size: 0.9rem;">Subtotal: <span id="venda-subtotal">R$ 0,00</span></div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">TOTAL: <span id="venda-total">R$ 0,00</span></div>
                        </div>
                    </div>

                    <div id="area-pagamento">
                        <hr style="margin: 10px 0;">
                        <label>Formas de Pagamento</label>
                        <div id="venda-pagamentos"></div>
                        <button class="btn btn-sm btn-primary" onclick="addPagamentoRow()">+ Adicionar Pagamento</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning" id="btn-orcamento" onclick="finalizarVenda(true)">Salvar Orçamento</button>
                <button class="btn btn-success" id="btn-finalizar" onclick="finalizarVenda(false)">Finalizar Venda</button>
            </div>
        </div>
    </div>

    <div id="printable-area"></div>

    <script>
        // --- CONFIGURAÇÃO DB ---
        const DB_NAME = 'OticaVision_V3_Full';
        const DB_VERSION = 3;
        let db;
        let config = { nome: 'Minha Ótica', tel: '', end: '', msg: '', logo: '' };
        let carrinho = [];
        let clientesCache = [];
        let produtosCache = [];

        // --- INICIALIZAÇÃO ---
        window.onload = () => {
            initDB();
            setupEvents();
            checkAuth();
        };

        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('produtos')) db.createObjectStore('produtos', { keyPath: 'id', autoIncrement: true });
                if (!db.objectStoreNames.contains('clientes')) db.createObjectStore('clientes', { keyPath: 'id', autoIncrement: true });
                if (!db.objectStoreNames.contains('vendas')) db.createObjectStore('vendas', { keyPath: 'id', autoIncrement: true });
                if (!db.objectStoreNames.contains('orcamentos')) db.createObjectStore('orcamentos', { keyPath: 'id', autoIncrement: true });
                if (!db.objectStoreNames.contains('config')) db.createObjectStore('config', { keyPath: 'id' });
            };

            request.onsuccess = (e) => {
                db = e.target.result;
                loadConfig();
                updateDashboard();
            };
        }

        // --- AUTH SIMPLES ---
        function checkAuth() {
            const user = sessionStorage.getItem('user');
            if (user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                document.getElementById('user-display').innerHTML = `<i class="fas fa-user"></i> ${user}`;
            }
        }

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            if (u === 'admin' && p === 'admin') {
                sessionStorage.setItem('user', 'Admin');
                location.reload();
            } else {
                alert('Senha incorreta!');
            }
        });

        document.getElementById('logout-btn').onclick = () => {
            sessionStorage.removeItem('user');
            location.reload();
        };

        // --- NAVEGAÇÃO ---
        function navTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(pageId + '-page').classList.add('active');
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            
            if(pageId === 'produtos') listarProdutos();
            if(pageId === 'clientes') listarClientes();
            if(pageId === 'vendas') listarVendas();
            if(pageId === 'orcamentos') listarOrcamentos();
            if(pageId === 'dashboard') updateDashboard();
        }

        document.querySelectorAll('.nav-link').forEach(link => {
            link.onclick = (e) => { e.preventDefault(); navTo(link.dataset.page); };
        });

        // --- FUNÇÕES DE CONFIGURAÇÃO ---
        function loadConfig() {
            const tx = db.transaction('config', 'readonly');
            tx.objectStore('config').get(1).onsuccess = (e) => {
                if (e.target.result) {
                    config = e.target.result;
                    applyConfig();
                }
            };
        }

        function applyConfig() {
            document.getElementById('store-name-display').innerText = config.nome || 'Ótica VisionPlus';
            if (config.logo) {
                const img = document.getElementById('header-logo');
                img.src = config.logo;
                img.style.display = 'block';
                document.getElementById('conf-logo-preview').src = config.logo;
                document.getElementById('conf-logo-preview').style.display = 'block';
            }
            // Preencher form
            document.getElementById('conf-nome').value = config.nome;
            document.getElementById('conf-tel').value = config.tel;
            document.getElementById('conf-end').value = config.end;
            document.getElementById('conf-msg').value = config.msg;
        }

        function salvarConfig() {
            config.nome = document.getElementById('conf-nome').value;
            config.tel = document.getElementById('conf-tel').value;
            config.end = document.getElementById('conf-end').value;
            config.msg = document.getElementById('conf-msg').value;
            config.id = 1; // Sempre ID 1

            const tx = db.transaction('config', 'readwrite');
            tx.objectStore('config').put(config);
            alert('Configurações salvas!');
            applyConfig();
        }

        // Image Reader
        document.getElementById('conf-logo-input').onchange = function() { readFile(this, (res) => { config.logo = res; document.getElementById('conf-logo-preview').src = res; document.getElementById('conf-logo-preview').style.display = 'block'; }); };
        document.getElementById('prod-img-input').onchange = function() { readFile(this, (res) => { document.getElementById('prod-img-preview').src = res; document.getElementById('prod-img-preview').style.display = 'block'; }); };

        function readFile(input, callback) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => callback(e.target.result);
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- PRODUTOS ---
        function openProdutoModal() {
            document.getElementById('form-produto').reset();
            document.getElementById('prod-id').value = '';
            document.getElementById('prod-img-preview').style.display = 'none';
            document.getElementById('barcode-preview').innerHTML = '';
            document.getElementById('modal-produto').classList.add('active');
        }

        function gerarCodigoBarras() {
            const code = Math.floor(Math.random() * 9000000000000) + 1000000000000;
            document.getElementById('prod-cod').value = code;
            JsBarcode("#barcode-preview", code.toString(), { height: 40 });
        }

        document.getElementById('prod-cod').addEventListener('keyup', function() {
             if(this.value.length > 0) JsBarcode("#barcode-preview", this.value, { height: 40 });
        });

        function salvarProduto() {
            const data = {
                nome: document.getElementById('prod-nome').value,
                cod: document.getElementById('prod-cod').value,
                cat: document.getElementById('prod-cat').value,
                preco: parseFloat(document.getElementById('prod-preco').value),
                qtd: parseInt(document.getElementById('prod-qtd').value),
                min: parseInt(document.getElementById('prod-min').value),
                foto: document.getElementById('prod-img-preview').src
            };
            
            const id = document.getElementById('prod-id').value;
            if(id) data.id = parseInt(id);

            const tx = db.transaction('produtos', 'readwrite');
            tx.objectStore('produtos').put(data);
            tx.oncomplete = () => {
                document.getElementById('modal-produto').classList.remove('active');
                listarProdutos();
                updateDashboard();
            };
        }

        function listarProdutos() {
            const tbody = document.getElementById('produtos-list');
            tbody.innerHTML = '';
            db.transaction('produtos').objectStore('produtos').getAll().onsuccess = (e) => {
                produtosCache = e.target.result;
                produtosCache.forEach(p => {
                    const img = p.foto && p.foto.length > 50 ? `<img src="${p.foto}" class="prod-thumb">` : '<i class="fas fa-image" style="color:#ccc"></i>';
                    tbody.innerHTML += `<tr>
                        <td>${img}</td>
                        <td>${p.cod || '-'}</td>
                        <td>${p.nome}</td>
                        <td><span style="color: ${p.qtd <= p.min ? 'red' : 'green'}">${p.qtd}</span></td>
                        <td>R$ ${p.preco.toFixed(2)}</td>
                        <td><button class="btn btn-sm btn-primary" onclick="editarProduto(${p.id})"><i class="fas fa-edit"></i></button></td>
                    </tr>`;
                });
            };
        }

        function editarProduto(id) {
            openProdutoModal();
            const p = produtosCache.find(x => x.id === id);
            document.getElementById('prod-id').value = p.id;
            document.getElementById('prod-nome').value = p.nome;
            document.getElementById('prod-cod').value = p.cod;
            document.getElementById('prod-cat').value = p.cat;
            document.getElementById('prod-preco').value = p.preco;
            document.getElementById('prod-qtd').value = p.qtd;
            document.getElementById('prod-min').value = p.min;
            if(p.foto && p.foto.length > 50) {
                document.getElementById('prod-img-preview').src = p.foto;
                document.getElementById('prod-img-preview').style.display = 'block';
            }
            if(p.cod) JsBarcode("#barcode-preview", p.cod, { height: 40 });
        }

        // --- CLIENTES ---
        function salvarCliente() {
            const data = {
                nome: document.getElementById('cli-nome').value,
                cpf: document.getElementById('cli-cpf').value,
                tel: document.getElementById('cli-tel').value,
                nasc: document.getElementById('cli-nasc').value,
                obs: document.getElementById('cli-obs').value
            };
            const id = document.getElementById('cli-id').value;
            if(id) data.id = parseInt(id);

            db.transaction('clientes', 'readwrite').objectStore('clientes').put(data).onsuccess = () => {
                document.getElementById('modal-cliente').classList.remove('active');
                listarClientes();
            };
        }

        function listarClientes() {
            db.transaction('clientes').objectStore('clientes').getAll().onsuccess = (e) => {
                clientesCache = e.target.result;
                filterClientes();
            };
        }

        function filterClientes() {
            const term = document.getElementById('search-cliente').value.toLowerCase();
            const tbody = document.getElementById('clientes-list');
            tbody.innerHTML = '';
            clientesCache.filter(c => c.nome.toLowerCase().includes(term) || (c.cpf && c.cpf.includes(term))).forEach(c => {
                tbody.innerHTML += `<tr>
                    <td>${c.nome}</td>
                    <td>${c.tel}</td>
                    <td>${c.nasc ? new Date(c.nasc).toLocaleDateString() : '-'}</td>
                    <td><button class="btn btn-sm btn-primary" onclick="editarCliente(${c.id})"><i class="fas fa-edit"></i></button></td>
                </tr>`;
            });
        }

        function openClienteModal() {
             document.getElementById('form-cliente').reset();
             document.getElementById('cli-id').value = '';
             document.getElementById('modal-cliente').classList.add('active');
        }

        function editarCliente(id) {
            const c = clientesCache.find(x => x.id === id);
            openClienteModal();
            document.getElementById('cli-id').value = c.id;
            document.getElementById('cli-nome').value = c.nome;
            document.getElementById('cli-cpf').value = c.cpf;
            document.getElementById('cli-tel').value = c.tel;
            document.getElementById('cli-nasc').value = c.nasc;
            document.getElementById('cli-obs').value = c.obs;
        }

        // --- VENDAS & PDV (COM LEITOR DE CÓDIGO) ---
        function openVendaModal(orcamento = false) {
            carrinho = [];
            document.getElementById('venda-data').value = new Date().toISOString().split('T')[0];
            document.getElementById('venda-titulo').innerText = orcamento ? 'Novo Orçamento' : 'Nova Venda';
            
            // Toggle botões
            document.getElementById('btn-orcamento').style.display = 'inline-block';
            document.getElementById('btn-finalizar').style.display = orcamento ? 'none' : 'inline-block';
            document.getElementById('area-pagamento').style.display = orcamento ? 'none' : 'block';

            // Carrega Clientes no Select
            const sel = document.getElementById('venda-cliente');
            sel.innerHTML = '<option value="">Cliente Balcão</option>';
            db.transaction('clientes').objectStore('clientes').getAll().onsuccess = (e) => {
                e.target.result.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.nome}</option>`);
            };

            // Reset Pagamentos
            document.getElementById('venda-pagamentos').innerHTML = '';
            addPagamentoRow();

            document.getElementById('modal-venda').classList.add('active');
            renderCarrinho();
            
            // Foco no input do leitor
            setTimeout(() => document.getElementById('venda-search').focus(), 500);
        }

        // Lógica do Leitor de Código de Barras
        document.getElementById('venda-search').addEventListener('keydown', function(e) {
            if(e.key === 'Enter') {
                e.preventDefault();
                const termo = this.value.trim();
                if(!termo) return;

                // Busca exata por código ou parcial por nome
                db.transaction('produtos').objectStore('produtos').getAll().onsuccess = (ev) => {
                    const todos = ev.target.result;
                    // Tenta achar código exato primeiro
                    let prod = todos.find(p => p.cod === termo);
                    
                    if(!prod) {
                        // Se não achou código, tenta nome
                        const matches = todos.filter(p => p.nome.toLowerCase().includes(termo.toLowerCase()));
                        if(matches.length === 1) prod = matches[0];
                    }

                    if(prod) {
                        const qtd = parseInt(document.getElementById('venda-qtd-add').value);
                        addAoCarrinho(prod, qtd);
                        this.value = ''; // Limpa para próximo bipe
                        document.getElementById('venda-qtd-add').value = 1;
                        // Som de sucesso (opcional)
                    } else {
                        alert('Produto não encontrado!');
                    }
                };
            }
        });

        function addAoCarrinho(prod, qtd) {
            const existe = carrinho.find(i => i.id === prod.id);
            if(existe) existe.qtd += qtd;
            else carrinho.push({ id: prod.id, nome: prod.nome, preco: prod.preco, qtd: qtd });
            renderCarrinho();
        }

        function renderCarrinho() {
            const tbody = document.getElementById('venda-itens');
            tbody.innerHTML = '';
            let total = 0;
            carrinho.forEach((item, idx) => {
                const sub = item.preco * item.qtd;
                total += sub;
                tbody.innerHTML += `<tr>
                    <td>${item.nome}</td>
                    <td>${item.qtd}</td>
                    <td>R$ ${item.preco.toFixed(2)}</td>
                    <td>R$ ${sub.toFixed(2)}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="carrinho.splice(${idx},1); renderCarrinho()">X</button></td>
                </tr>`;
            });
            const desc = parseFloat(document.getElementById('venda-desc').value) || 0;
            document.getElementById('venda-subtotal').innerText = `R$ ${total.toFixed(2)}`;
            document.getElementById('venda-total').innerText = `R$ ${(total - desc).toFixed(2)}`;
        }

        function addPagamentoRow() {
            const div = document.createElement('div');
            div.className = 'payment-row';
            div.innerHTML = `
                <select class="pay-method form-control">
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Pix">Pix</option>
                    <option value="Cartão Crédito">Cartão Crédito</option>
                    <option value="Cartão Débito">Cartão Débito</option>
                </select>
                <input type="number" step="0.01" class="pay-value form-control" placeholder="Valor">
                <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">X</button>
            `;
            document.getElementById('venda-pagamentos').appendChild(div);
        }

        function finalizarVenda(isOrcamento) {
            if(carrinho.length === 0) return alert('Carrinho vazio!');
            
            const cliId = document.getElementById('venda-cliente').value;
            const desc = parseFloat(document.getElementById('venda-desc').value) || 0;
            const totalItens = carrinho.reduce((acc, i) => acc + (i.preco * i.qtd), 0);
            const totalFinal = totalItens - desc;

            const registro = {
                data: document.getElementById('venda-data').value,
                clienteId: cliId ? parseInt(cliId) : null,
                itens: carrinho,
                desconto: desc,
                total: totalFinal,
                timestamp: new Date().getTime()
            };

            if(!isOrcamento) {
                // Processar Venda
                const pags = [];
                let pago = 0;
                document.querySelectorAll('.payment-row').forEach(row => {
                    const val = parseFloat(row.querySelector('.pay-value').value) || 0;
                    if(val > 0) {
                        pags.push({ metodo: row.querySelector('.pay-method').value, valor: val });
                        pago += val;
                    }
                });

                if(Math.abs(pago - totalFinal) > 0.05) {
                    if(!confirm(`Total Pago (R$ ${pago}) diferente do Total da Venda. Confirmar?`)) return;
                }
                registro.pagamentos = pags;

                // Baixar Estoque
                const txProd = db.transaction('produtos', 'readwrite');
                carrinho.forEach(item => {
                    txProd.objectStore('produtos').get(item.id).onsuccess = (e) => {
                        const p = e.target.result;
                        p.qtd -= item.qtd;
                        txProd.objectStore('produtos').put(p);
                    };
                });
                
                db.transaction('vendas', 'readwrite').objectStore('vendas').add(registro).onsuccess = (e) => {
                    alert('Venda Realizada!');
                    document.getElementById('modal-venda').classList.remove('active');
                    updateDashboard();
                    imprimirComprovante(registro, e.target.result);
                };

            } else {
                // Processar Orçamento
                db.transaction('orcamentos', 'readwrite').objectStore('orcamentos').add(registro).onsuccess = () => {
                    alert('Orçamento Salvo!');
                    document.getElementById('modal-venda').classList.remove('active');
                    listarOrcamentos();
                    updateDashboard();
                };
            }
        }

        // --- LISTAGENS ---
        function listarVendas() {
            const tbody = document.getElementById('vendas-list');
            tbody.innerHTML = '';
            db.transaction('vendas').objectStore('vendas').openCursor(null, 'prev').onsuccess = (e) => {
                const cursor = e.target.result;
                if(cursor) {
                    const v = cursor.value;
                    tbody.innerHTML += `<tr>
                        <td>${v.id}</td>
                        <td>${new Date(v.data).toLocaleDateString()}</td>
                        <td>${getClientName(v.clienteId)}</td>
                        <td>R$ ${v.total.toFixed(2)}</td>
                        <td><button class="btn btn-sm btn-primary" onclick='reimprimir(${JSON.stringify(v)}, ${v.id})'><i class="fas fa-print"></i></button></td>
                    </tr>`;
                    cursor.continue();
                }
            };
        }

        function listarOrcamentos() {
            const tbody = document.getElementById('orcamentos-list');
            tbody.innerHTML = '';
            db.transaction('orcamentos').objectStore('orcamentos').openCursor(null, 'prev').onsuccess = (e) => {
                const cursor = e.target.result;
                if(cursor) {
                    const v = cursor.value;
                    const cliNome = getClientName(v.clienteId);
                    tbody.innerHTML += `<tr>
                        <td>${v.id}</td>
                        <td>${new Date(v.data).toLocaleDateString()}</td>
                        <td>${cliNome}</td>
                        <td>R$ ${v.total.toFixed(2)}</td>
                        <td><button class="btn btn-sm btn-success" onclick="enviarWhatsApp(${v.id}, '${cliNome}', ${v.total}, ${v.clienteId})"><i class="fab fa-whatsapp"></i> Enviar</button></td>
                        <td><button class="btn btn-sm btn-primary" onclick='alert("Carregar este orcamento na venda - Implementar se desejar")'>Abrir</button></td>
                    </tr>`;
                    cursor.continue();
                }
            };
        }

        // --- INTEGRAÇÃO WHATSAPP ---
        function enviarWhatsApp(idOrcamento, nomeCliente, valor, clienteId) {
            // Pegar telefone do cliente
            if(!clienteId) return alert('Orçamento sem cliente cadastrado para envio.');
            
            db.transaction('clientes').objectStore('clientes').get(clienteId).onsuccess = (e) => {
                const cli = e.target.result;
                if(!cli || !cli.tel) return alert('Cliente sem telefone cadastrado.');
                
                // Formatar telefone (remove caracteres não numéricos e garante 55)
                let fone = cli.tel.replace(/\D/g, '');
                if(fone.length < 12) fone = '55' + fone; // Adiciona DDI Brasil se faltar
                
                const texto = `Olá *${nomeCliente}*! 
Aqui está o seu orçamento da *${config.nome}*.
                
*Orçamento #${idOrcamento}*
Valor Total: R$ ${valor.toFixed(2)}
                
Qualquer dúvida estamos à disposição!`;

                const url = `https://wa.me/${fone}?text=${encodeURIComponent(texto)}`;
                window.open(url, '_blank');
            };
        }

        // --- DASHBOARD & ALERTAS ---
        function updateDashboard() {
            // Vendas Hoje
            const hoje = new Date().toISOString().split('T')[0];
            db.transaction('vendas').objectStore('vendas').getAll().onsuccess = (e) => {
                const total = e.target.result.filter(v => v.data === hoje).reduce((acc, v) => acc + v.total, 0);
                document.getElementById('dash-vendas-hoje').innerText = `R$ ${total.toFixed(2)}`;
            };

            // Estoque Baixo
            const listaEstoque = document.getElementById('dash-estoque-baixo');
            listaEstoque.innerHTML = '';
            db.transaction('produtos').objectStore('produtos').getAll().onsuccess = (e) => {
                const baixos = e.target.result.filter(p => p.qtd <= p.min);
                if(baixos.length === 0) listaEstoque.innerHTML = '<li>Tudo ok!</li>';
                baixos.forEach(p => {
                    listaEstoque.innerHTML += `<li>${p.nome} <span class="badge-alert">${p.qtd} un</span></li>`;
                });
            };

            // Aniversariantes
            const mesAtual = new Date().getMonth();
            const listaNiver = document.getElementById('dash-aniversariantes');
            listaNiver.innerHTML = '';
            db.transaction('clientes').objectStore('clientes').getAll().onsuccess = (e) => {
                const aniversariantes = e.target.result.filter(c => {
                    if(!c.nasc) return false;
                    const d = new Date(c.nasc);
                    // Ajuste de fuso horário simples
                    d.setMinutes(d.getMinutes() + d.getTimezoneOffset()); 
                    return d.getMonth() === mesAtual;
                });
                
                if(aniversariantes.length === 0) listaNiver.innerHTML = '<li>Nenhum este mês.</li>';
                aniversariantes.forEach(c => {
                    const dia = new Date(c.nasc).getDate() + 1; // Ajuste visual
                    listaNiver.innerHTML += `<li>${c.nome} - Dia ${dia} <button class="btn btn-sm btn-success" style="padding:2px 5px" onclick="enviarWhatsAppParabens('${c.nome}', '${c.tel}')"><i class="fab fa-whatsapp"></i></button></li>`;
                });
            };
        }

        function enviarWhatsAppParabens(nome, tel) {
            let fone = tel.replace(/\D/g, '');
            if(fone.length < 12) fone = '55' + fone;
            const msg = `Parabéns *${nome}*! A *${config.nome}* deseja um feliz aniversário! Venha nos visitar e ganhe um desconto especial este mês! 🎉`;
            window.open(`https://wa.me/${fone}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // --- IMPRESSÃO TÉRMICA ---
        function reimprimir(venda, id) {
            imprimirComprovante(venda, id);
        }

        function imprimirComprovante(venda, id) {
            const area = document.getElementById('printable-area');
            const cliNome = getClientName(venda.clienteId);
            
            let itensHtml = '';
            venda.itens.forEach(i => {
                itensHtml += `
                <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:2px;">
                    <span>${i.qtd}x ${i.nome.substring(0, 15)}</span>
                    <span>${(i.preco * i.qtd).toFixed(2)}</span>
                </div>`;
            });

            const html = `
                <div style="width: 80mm; font-family: 'Courier New', monospace; font-size: 12px; text-align: center; padding: 5px;">
                    <h3 style="margin:0">${config.nome}</h3>
                    <p style="margin:0; font-size:10px">${config.end}</p>
                    <p style="margin:0; font-size:10px">${config.tel}</p>
                    <hr style="border-top: 1px dashed #000; margin: 5px 0;">
                    <div style="text-align:left">
                        VENDA #${id}<br>
                        DATA: ${new Date(venda.data).toLocaleDateString()} ${new Date(venda.timestamp || Date.now()).toLocaleTimeString()}<br>
                        CLI: ${cliNome}
                    </div>
                    <hr style="border-top: 1px dashed #000; margin: 5px 0;">
                    ${itensHtml}
                    <hr style="border-top: 1px dashed #000; margin: 5px 0;">
                    <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:14px;">
                        <span>TOTAL</span>
                        <span>R$ ${venda.total.toFixed(2)}</span>
                    </div>
                     <div style="text-align:left; font-size:10px; margin-top:5px;">
                        Desc: R$ ${venda.desconto.toFixed(2)}<br>
                        ${venda.pagamentos ? venda.pagamentos.map(p=> p.metodo).join(', ') : ''}
                    </div>
                    <hr style="border-top: 1px dashed #000; margin: 5px 0;">
                    <p style="margin-top:10px; font-size:10px;">${config.msg}</p>
                </div>
            `;
            
            area.innerHTML = html;
            window.print();
            // Limpa após impressão para não aparecer no fundo se o CSS falhar
            setTimeout(() => area.innerHTML = '', 2000); 
        }

        // --- HELPER ---
        function getClientName(id) {
            if(!id) return 'Consumidor Final';
            const c = clientesCache.find(x => x.id === id);
            return c ? c.nome : 'Desconhecido';
        }

        function setupEvents() {
            document.querySelectorAll('.modal-close').forEach(btn => btn.onclick = function() { this.closest('.modal').classList.remove('active'); });
            
            // Carregar cache inicial
            setTimeout(() => {
                db.transaction('clientes').objectStore('clientes').getAll().onsuccess = e => clientesCache = e.target.result;
            }, 1000);
        }

    </script>
</body>
</html>

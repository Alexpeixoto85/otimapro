<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ótica VisionPlus - Sistema Completo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            text-align: center;
        }

        .login-logo {
            margin-bottom: 1.5rem;
        }

        .login-logo img {
            max-width: 150px;
            height: auto;
        }

        .login-title {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        /* Header */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-img {
            max-height: 50px;
        }

        .logo-text h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .logo-text p {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-btn {
            background: none;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            transition: background-color 0.3s;
        }

        .user-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-dropdown {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            z-index: 100;
            overflow: hidden;
        }

        .user-menu:hover .user-dropdown {
            display: block;
        }

        .user-dropdown a {
            color: var(--primary-color);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s;
        }

        .user-dropdown a:hover {
            background-color: #f1f1f1;
        }

        /* Navigation */
        nav {
            background-color: var(--secondary-color);
            padding: 0.5rem;
            box-shadow: var(--shadow);
            position: relative;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            justify-content: flex-start;
            flex-wrap: wrap;
            gap: 5px;
        }

        .nav-menu li {
            padding: 0.3rem 0.7rem;
        }

        .nav-menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: background-color 0.3s;
            font-size: 0.9rem;
        }

        .nav-menu a:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .nav-menu a.active {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .nav-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Main Content */
        main {
            flex: 1;
            padding: 1.5rem;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-title {
            color: var(--primary-color);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 0.7rem 1.2rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #d68910;
        }

        .btn-danger {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        /* Cards */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--secondary-color);
        }

        .card-info {
            color: #666;
            font-size: 0.85rem;
        }

        /* Tables */
        .table-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th, td {
            padding: 0.8rem 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            color: var(--primary-color);
            font-weight: 600;
            white-space: nowrap;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .status {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-pendente {
            background-color: #fef9e7;
            color: #d4ac0d;
        }

        .status-concluido {
            background-color: #eafaf1;
            color: var(--success-color);
        }

        .status-cancelado {
            background-color: #fdedec;
            color: var(--accent-color);
        }

        .status-entregue {
            background-color: #e8f4fc;
            color: var(--secondary-color);
        }

        /* Forms */
        .form-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .required:after {
            content: " *";
            color: var(--accent-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        /* Barcode Scanner */
        .barcode-scanner {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        #barcode-video {
            width: 100%;
            border-radius: var(--border-radius);
        }

        .barcode-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 150px;
            border: 2px solid var(--secondary-color);
            pointer-events: none;
        }

        /* Product Image */
        .product-image-container {
            width: 100%;
            height: 200px;
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin-bottom: 1rem;
            cursor: pointer;
            background-color: #f9f9f9;
        }

        .product-image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .product-image-placeholder {
            text-align: center;
            color: #666;
        }

        .product-image-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #ccc;
        }

        /* Alertas */
        .alert {
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-warning {
            background-color: #fef9e7;
            border-left: 4px solid var(--warning-color);
        }

        .alert-success {
            background-color: #eafaf1;
            border-left: 4px solid var(--success-color);
        }

        .alert-danger {
            background-color: #fdedec;
            border-left: 4px solid var(--accent-color);
        }

        /* Configurações */
        .config-section {
            margin-bottom: 2rem;
        }

        .config-section h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #eee;
        }

        /* Aniversariantes */
        .birthday-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 1rem;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1rem;
        }

        .birthday-icon {
            width: 50px;
            height: 50px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .birthday-info h4 {
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .birthday-info p {
            color: #666;
            font-size: 0.9rem;
        }

        /* Footer */
        footer {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 1rem;
            margin-top: auto;
        }

        /* Impressão */
        @media print {
            header, nav, footer, .no-print {
                display: none !important;
            }
            
            body {
                background-color: white;
            }
            
            .page {
                display: block !important;
            }
            
            .table-container {
                box-shadow: none;
            }
        }

        /* Recibo térmico */
        .thermal-receipt {
            width: 80mm;
            background-color: white;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.2;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 1px dashed #000;
            padding-bottom: 10px;
        }

        .receipt-items {
            margin: 10px 0;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .receipt-total {
            border-top: 1px dashed #000;
            padding-top: 10px;
            margin-top: 10px;
            font-weight: bold;
        }

        /* Pagamentos Múltiplos */
        .payment-methods-container {
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .payment-method-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0.5rem;
            background-color: white;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            border: 1px solid #eee;
        }

        .payment-method-item input {
            flex: 1;
            min-width: 0;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .cards-container {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .nav-toggle {
                display: block;
            }
            
            .nav-menu {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background-color: var(--secondary-color);
                z-index: 100;
                padding: 1rem;
                box-shadow: var(--shadow);
            }
            
            .nav-menu.active {
                display: flex;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .cards-container {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 0.7rem;
            }
            
            .header-controls {
                flex-wrap: wrap;
                justify-content: flex-end;
            }
        }

        @media (max-width: 480px) {
            .logo-text h1 {
                font-size: 1.2rem;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            
            .modal-content {
                width: 95%;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <img id="login-logo-img" src="" alt="Logo Ótica" style="display: none;">
                <h2 style="color: var(--primary-color);"><i class="fas fa-glasses"></i> Ótica VisionPlus</h2>
            </div>
            <h2 class="login-title">Acesso ao Sistema</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-username">Usuário</label>
                    <input type="text" id="login-username" placeholder="Digite seu usuário" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Senha</label>
                    <input type="password" id="login-password" placeholder="Digite sua senha" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                </div>
                <div class="form-group" style="text-align: left; font-size: 0.9rem;">
                    <p>Usuário: <strong>admin</strong> | Senha: <strong>admin123</strong></p>
                    <p>Usuário: <strong>vendedor</strong> | Senha: <strong>vendedor123</strong></p>
                </div>
            </form>
        </div>
    </div>

    <!-- Sistema Principal (inicialmente oculto) -->
    <div id="app-container" class="container" style="display: none;">
        <header>
            <div class="logo-container">
                <img id="header-logo" class="logo-img" src="" alt="Logo" style="display: none;">
                <div class="logo-text">
                    <h1 id="store-name">Ótica VisionPlus</h1>
                    <p id="store-slogan">Sistema Completo de Gestão</p>
                </div>
            </div>
            <div class="header-controls">
                <div class="user-menu">
                    <button class="user-btn">
                        <i class="fas fa-user-circle"></i>
                        <span id="current-user">Administrador</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-dropdown">
                        <a href="#configuracoes" data-page="configuracoes"><i class="fas fa-cog"></i> Configurações</a>
                        <a href="#" id="backup-btn"><i class="fas fa-database"></i> Backup/Restore</a>
                        <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Sair</a>
                    </div>
                </div>
                <div id="current-date-time" style="font-size: 0.9rem;"></div>
            </div>
        </header>

        <nav>
            <button class="nav-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <ul class="nav-menu">
                <li><a href="#dashboard" class="nav-link active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#clientes" class="nav-link" data-page="clientes"><i class="fas fa-users"></i> Clientes</a></li>
                <li><a href="#orcamentos" class="nav-link" data-page="orcamentos"><i class="fas fa-file-invoice-dollar"></i> Orçamentos</a></li>
                <li><a href="#vendas" class="nav-link" data-page="vendas"><i class="fas fa-shopping-cart"></i> Vendas</a></li>
                <li><a href="#produtos" class="nav-link" data-page="produtos"><i class="fas fa-glasses"></i> Produtos</a></li>
                <li><a href="#posvenda" class="nav-link" data-page="posvenda"><i class="fas fa-headset"></i> Pós-Venda</a></li>
                <li><a href="#relatorios" class="nav-link" data-page="relatorios"><i class="fas fa-chart-bar"></i> Relatórios</a></li>
            </ul>
        </nav>

        <main>
            <!-- Dashboard -->
            <section id="dashboard-page" class="page active">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                    <div>
                        <button class="btn btn-primary" id="quick-sale-btn"><i class="fas fa-bolt"></i> Venda Rápida</button>
                        <button class="btn btn-success" id="new-budget-btn"><i class="fas fa-plus"></i> Novo Orçamento</button>
                    </div>
                </div>

                <!-- Alertas -->
                <div id="dashboard-alerts"></div>

                <!-- Aniversariantes do Mês -->
                <div class="form-container" id="birthdays-container" style="display: none;">
                    <h3><i class="fas fa-birthday-cake"></i> Aniversariantes do Mês</h3>
                    <div id="birthdays-list"></div>
                </div>

                <div class="cards-container">
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-file-invoice-dollar"></i> Orçamentos Hoje</h3>
                        <p class="card-value" id="orcamentos-hoje">0</p>
                        <p class="card-info">Total de orçamentos realizados hoje</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-shopping-cart"></i> Vendas Hoje</h3>
                        <p class="card-value" id="vendas-hoje">0</p>
                        <p class="card-info">Total de vendas realizadas hoje</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-dollar-sign"></i> Faturamento</h3>
                        <p class="card-value" id="faturamento-hoje">R$ 0,00</p>
                        <p class="card-info">Faturamento total do dia</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> Estoque Baixo</h3>
                        <p class="card-value" id="estoque-baixo-count">0</p>
                        <p class="card-info">Produtos com estoque abaixo do mínimo</p>
                    </div>
                </div>

                <div class="tabs" style="margin-top: 2rem;">
                    <button class="tab active" data-tab="orcamentos-recentes">Orçamentos Recentes</button>
                    <button class="tab" data-tab="vendas-recentes">Vendas Recentes</button>
                    <button class="tab" data-tab="servicos-pendentes">Serviços Pendentes</button>
                </div>

                <div class="table-container">
                    <table id="tabela-orcamentos-recentes">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Data</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="orcamentos-recentes-body">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Clientes -->
            <section id="clientes-page" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-users"></i> Clientes</h2>
                    <div>
                        <button class="btn btn-primary" id="novo-cliente-btn"><i class="fas fa-plus"></i> Novo Cliente</button>
                        <button class="btn btn-success" id="import-clientes-btn"><i class="fas fa-file-import"></i> Importar</button>
                    </div>
                </div>

                <div class="form-container" id="filtro-clientes">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="filtro-nome">Nome</label>
                            <input type="text" id="filtro-nome" placeholder="Pesquisar por nome">
                        </div>
                        <div class="form-group">
                            <label for="filtro-telefone">Telefone</label>
                            <input type="text" id="filtro-telefone" placeholder="Pesquisar por telefone">
                        </div>
                        <div class="form-group">
                            <label for="filtro-email">E-mail</label>
                            <input type="email" id="filtro-email" placeholder="Pesquisar por e-mail">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" id="filtrar-clientes"><i class="fas fa-search"></i> Filtrar</button>
                        <button class="btn" id="limpar-filtros"><i class="fas fa-times"></i> Limpar</button>
                        <button class="btn btn-success" id="export-clientes-btn"><i class="fas fa-file-export"></i> Exportar</button>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Telefone</th>
                                <th>E-mail</th>
                                <th>Data Nasc.</th>
                                <th>Aniversário</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="clientes-body">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Orçamentos -->
            <section id="orcamentos-page" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-file-invoice-dollar"></i> Orçamentos</h2>
                    <button class="btn btn-primary" id="novo-orcamento-btn"><i class="fas fa-plus"></i> Novo Orçamento</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Data</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>WhatsApp</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="orcamentos-body">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Vendas -->
            <section id="vendas-page" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-shopping-cart"></i> Vendas</h2>
                    <div>
                        <button class="btn btn-primary" id="nova-venda-btn"><i class="fas fa-plus"></i> Nova Venda</button>
                        <button class="btn btn-warning" id="scan-venda-btn"><i class="fas fa-barcode"></i> Leitor Código</button>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Data</th>
                                <th>Valor Total</th>
                                <th>Forma Pagamento</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="vendas-body">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Produtos -->
            <section id="produtos-page" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-glasses"></i> Produtos</h2>
                    <div>
                        <button class="btn btn-primary" id="novo-produto-btn"><i class="fas fa-plus"></i> Novo Produto</button>
                        <button class="btn btn-warning" id="scan-produto-btn"><i class="fas fa-barcode"></i> Leitor Código</button>
                        <button class="btn btn-success" id="export-produtos-btn"><i class="fas fa-file-export"></i> Exportar</button>
                    </div>
                </div>

                <div class="cards-container">
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-eye"></i> Armações</h3>
                        <p class="card-value" id="total-armacoes">0</p>
                        <p class="card-info">Total de armações em estoque</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-low-vision"></i> Lentes</h3>
                        <p class="card-value" id="total-lentes">0</p>
                        <p class="card-info">Total de lentes em estoque</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-tint"></i> Soluções</h3>
                        <p class="card-value" id="total-solucoes">0</p>
                        <p class="card-info">Total de soluções em estoque</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-box"></i> Total Produtos</h3>
                        <p class="card-value" id="total-produtos">0</p>
                        <p class="card-info">Produtos cadastrados no sistema</p>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Foto</th>
                                <th>Produto</th>
                                <th>Categoria</th>
                                <th>Estoque</th>
                                <th>Preço</th>
                                <th>Cód. Barras</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="produtos-body">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Pós-Venda -->
            <section id="posvenda-page" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-headset"></i> Pós-Venda</h2>
                    <button class="btn btn-primary" id="novo-servico-btn"><i class="fas fa-plus"></i> Novo Serviço</button>
                </div>

                <div class="cards-container">
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-tools"></i> Serviços Pendentes</h3>
                        <p class="card-value" id="servicos-pendentes">0</p>
                        <p class="card-info">Serviços aguardando execução</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-clock"></i> Aguardando Retirada</h3>
                        <p class="card-value" id="aguardando-retirada">0</p>
                        <p class="card-info">Produtos prontos para retirada</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-calendar-check"></i> Garantias Ativas</h3>
                        <p class="card-value" id="garantias-ativas">0</p>
                        <p class="card-info">Garantias em vigência</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-comment-dots"></i> Reclamações</h3>
                        <p class="card-value" id="reclamacoes">0</p>
                        <p class="card-info">Reclamações em aberto</p>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Serviço</th>
                                <th>Data Solicitação</th>
                                <th>Previsão Entrega</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="posvenda-body">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Relatórios -->
            <section id="relatorios-page" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-chart-bar"></i> Relatórios</h2>
                    <button class="btn btn-primary" id="gerar-relatorio-btn"><i class="fas fa-download"></i> Gerar Relatório</button>
                </div>

                <div class="cards-container">
                    <div class="card" onclick="gerarRelatorio('vendas')" style="cursor: pointer;">
                        <h3 class="card-title"><i class="fas fa-chart-line"></i> Vendas</h3>
                        <p class="card-info">Relatório de vendas por período</p>
                    </div>
                    <div class="card" onclick="gerarRelatorio('estoque')" style="cursor: pointer;">
                        <h3 class="card-title"><i class="fas fa-boxes"></i> Estoque</h3>
                        <p class="card-info">Relatório de estoque atual</p>
                    </div>
                    <div class="card" onclick="gerarRelatorio('financeiro')" style="cursor: pointer;">
                        <h3 class="card-title"><i class="fas fa-money-bill-wave"></i> Financeiro</h3>
                        <p class="card-info">Relatório financeiro</p>
                    </div>
                    <div class="card" onclick="gerarRelatorio('clientes')" style="cursor: pointer;">
                        <h3 class="card-title"><i class="fas fa-users"></i> Clientes</h3>
                        <p class="card-info">Relatório de clientes</p>
                    </div>
                </div>

                <div class="form-container">
                    <h3>Gerar Relatório Personalizado</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="relatorio-tipo">Tipo de Relatório</label>
                            <select id="relatorio-tipo">
                                <option value="vendas">Vendas</option>
                                <option value="estoque">Estoque</option>
                                <option value="financeiro">Financeiro</option>
                                <option value="clientes">Clientes</option>
                                <option value="produtos">Produtos Mais Vendidos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="relatorio-periodo">Período</label>
                            <select id="relatorio-periodo">
                                <option value="hoje">Hoje</option>
                                <option value="semana">Esta Semana</option>
                                <option value="mes" selected>Este Mês</option>
                                <option value="trimestre">Este Trimestre</option>
                                <option value="ano">Este Ano</option>
                                <option value="personalizado">Personalizado</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="custom-date-range" style="display: none;">
                        <div class="form-group">
                            <label for="data-inicio">Data Início</label>
                            <input type="date" id="data-inicio">
                        </div>
                        <div class="form-group">
                            <label for="data-fim">Data Fim</label>
                            <input type="date" id="data-fim">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" id="gerar-relatorio-custom"><i class="fas fa-download"></i> Gerar Relatório</button>
                        <button class="btn btn-success" id="exportar-pdf"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                    </div>
                </div>
            </section>

            <!-- Configurações -->
            <section id="configuracoes-page" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-cog"></i> Configurações da Loja</h2>
                </div>

                <div class="form-container">
                    <div class="config-section">
                        <h3><i class="fas fa-store"></i> Informações da Loja</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="config-nome" class="required">Nome da Loja</label>
                                <input type="text" id="config-nome" value="Ótica VisionPlus">
                            </div>
                            <div class="form-group">
                                <label for="config-slogan">Slogan</label>
                                <input type="text" id="config-slogan" value="Sistema Completo de Gestão">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="config-cnpj">CNPJ</label>
                                <input type="text" id="config-cnpj" placeholder="00.000.000/0000-00">
                            </div>
                            <div class="form-group">
                                <label for="config-telefone">Telefone</label>
                                <input type="text" id="config-telefone" placeholder="(11) 99999-9999">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="config-email">E-mail</label>
                                <input type="email" id="config-email" placeholder="contato@otica.com">
                            </div>
                            <div class="form-group">
                                <label for="config-endereco">Endereço</label>
                                <input type="text" id="config-endereco" placeholder="Rua Exemplo, 123">
                            </div>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3><i class="fas fa-image"></i> Logo da Loja</h3>
                        <div class="product-image-container" id="logo-upload-container">
                            <div class="product-image-placeholder">
                                <i class="fas fa-camera"></i>
                                <p>Clique para adicionar logo</p>
                                <p style="font-size: 0.8rem; color: #999;">Recomendado: 300x100px</p>
                            </div>
                            <input type="file" id="logo-upload" accept="image/*" style="display: none;">
                        </div>
                    </div>

                    <div class="config-section">
                        <h3><i class="fas fa-receipt"></i> Configurações de Venda</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="config-taxa-juros">Taxa de Juros (%)</label>
                                <input type="number" id="config-taxa-juros" value="2.5" step="0.1" min="0">
                            </div>
                            <div class="form-group">
                                <label for="config-dias-garantia">Dias de Garantia</label>
                                <input type="number" id="config-dias-garantia" value="90" min="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="config-impressora">Impressora Térmica</label>
                                <select id="config-impressora">
                                    <option value="browser">Navegador (Impressão Normal)</option>
                                    <option value="thermal">Modo Térmico (80mm)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="config-whatsapp">WhatsApp para Envios</label>
                                <input type="text" id="config-whatsapp" placeholder="5511999999999">
                            </div>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3><i class="fas fa-shield-alt"></i> Segurança e Backup</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="config-backup-auto">Backup Automático</label>
                                <select id="config-backup-auto">
                                    <option value="diario">Diário</option>
                                    <option value="semanal" selected>Semanal</option>
                                    <option value="mensal">Mensal</option>
                                    <option value="desativado">Desativado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="config-backup-path">Pasta de Backup</label>
                                <input type="text" id="config-backup-path" placeholder="C:/BackupOtica" readonly>
                                <button type="button" class="btn btn-sm" style="margin-top: 5px;" id="change-backup-path">Alterar</button>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-warning" id="backup-now-btn"><i class="fas fa-database"></i> Fazer Backup Agora</button>
                            <button class="btn btn-primary" id="restore-backup-btn"><i class="fas fa-history"></i> Restaurar Backup</button>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-success" id="save-config-btn"><i class="fas fa-save"></i> Salvar Configurações</button>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p id="footer-text">Ótica VisionPlus &copy; <span id="ano-atual"></span> - Sistema Completo de Gestão</p>
        </footer>
    </div>

    <!-- Modal para Cliente -->
    <div class="modal" id="cliente-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Novo Cliente</h3>
                <button class="modal-close" id="fechar-cliente-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-cliente">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cliente-nome" class="required">Nome Completo</label>
                            <input type="text" id="cliente-nome" required>
                        </div>
                        <div class="form-group">
                            <label for="cliente-cpf">CPF</label>
                            <input type="text" id="cliente-cpf" placeholder="000.000.000-00">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cliente-telefone" class="required">Telefone</label>
                            <input type="text" id="cliente-telefone" required>
                        </div>
                        <div class="form-group">
                            <label for="cliente-email">E-mail</label>
                            <input type="email" id="cliente-email">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cliente-data-nascimento">Data de Nascimento</label>
                            <input type="date" id="cliente-data-nascimento">
                        </div>
                        <div class="form-group">
                            <label for="cliente-grau">Grau (se aplicável)</label>
                            <input type="text" id="cliente-grau" placeholder="Ex: OD -2.00 / OE -1.75">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="cliente-observacoes">Observações</label>
                        <textarea id="cliente-observacoes" rows="3"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" id="cancelar-cliente">Cancelar</button>
                        <button type="submit" class="btn btn-success">Salvar Cliente</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Produto -->
    <div class="modal" id="produto-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Novo Produto</h3>
                <button class="modal-close" id="fechar-produto-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-produto">
                    <div class="product-image-container" id="product-image-upload-container">
                        <div class="product-image-placeholder">
                            <i class="fas fa-camera"></i>
                            <p>Clique para adicionar foto do produto</p>
                        </div>
                        <input type="file" id="product-image-upload" accept="image/*" style="display: none;">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="produto-codigo" class="required">Código</label>
                            <input type="text" id="produto-codigo" required>
                        </div>
                        <div class="form-group">
                            <label for="produto-nome" class="required">Nome</label>
                            <input type="text" id="produto-nome" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="produto-categoria" class="required">Categoria</label>
                            <select id="produto-categoria" required>
                                <option value="">Selecione</option>
                                <option value="armacao">Armação</option>
                                <option value="lente">Lente</option>
                                <option value="solucao">Solução</option>
                                <option value="acessorio">Acessório</option>
                                <option value="oculos_sol">Óculos de Sol</option>
                                <option value="lente_contato">Lente de Contato</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="produto-marca">Marca</label>
                            <input type="text" id="produto-marca">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="produto-estoque" class="required">Estoque Atual</label>
                            <input type="number" id="produto-estoque" required min="0">
                        </div>
                        <div class="form-group">
                            <label for="produto-estoque-minimo">Estoque Mínimo</label>
                            <input type="number" id="produto-estoque-minimo" min="0" value="5">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="produto-preco-custo">Preço de Custo</label>
                            <input type="number" id="produto-preco-custo" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="produto-preco-venda" class="required">Preço de Venda</label>
                            <input type="number" id="produto-preco-venda" required step="0.01" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="produto-codigo-barras">Código de Barras</label>
                            <input type="text" id="produto-codigo-barras" placeholder="Digite ou gere automaticamente">
                            <button type="button" class="btn btn-sm" style="margin-top: 5px;" id="generate-barcode">Gerar Código</button>
                            <div id="barcode-preview" style="margin-top: 10px;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="produto-descricao">Descrição</label>
                        <textarea id="produto-descricao" rows="3"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" id="cancelar-produto">Cancelar</button>
                        <button type="submit" class="btn btn-success">Salvar Produto</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Orçamento/Venda com Múltiplas Formas de Pagamento -->
    <div class="modal" id="venda-modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3 class="modal-title">Nova Venda</h3>
                <button class="modal-close" id="fechar-venda-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label for="venda-cliente">Cliente</label>
                        <select id="venda-cliente">
                            <option value="">Selecione um cliente</option>
                        </select>
                        <button type="button" class="btn btn-sm" style="margin-top: 5px;" id="novo-cliente-venda">Novo Cliente</button>
                    </div>
                    <div class="form-group">
                        <label for="venda-data">Data</label>
                        <input type="date" id="venda-data" value="<?php echo date('Y-m-d'); ?>">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <label for="venda-produto">Adicionar Produto</label>
                        <select id="venda-produto">
                            <option value="">Selecione um produto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="venda-quantidade">Quantidade</label>
                        <input type="number" id="venda-quantidade" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-primary" id="adicionar-produto-venda"><i class="fas fa-plus"></i> Adicionar</button>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <button type="button" class="btn btn-warning" id="scan-venda-modal"><i class="fas fa-barcode"></i> Ler Código de Barras</button>
                    </div>
                </div>

                <div class="table-container" style="margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Quantidade</th>
                                <th>Preço Unit.</th>
                                <th>Desconto</th>
                                <th>Subtotal</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="venda-itens-body">
                        </tbody>
                    </table>
                </div>

                <div class="form-row" style="justify-content: flex-end; margin-top: 1rem;">
                    <div style="text-align: right; min-width: 300px;">
                        <p><strong>Subtotal:</strong> <span id="venda-subtotal">R$ 0,00</span></p>
                        <p><strong>Desconto:</strong> <span id="venda-desconto">R$ 0,00</span></p>
                        <p><strong>Total:</strong> <span id="venda-total" style="font-size: 1.2rem; font-weight: bold;">R$ 0,00</span></p>
                    </div>
                </div>

                <!-- Múltiplas Formas de Pagamento -->
                <div class="payment-methods-container">
                    <h4><i class="fas fa-credit-card"></i> Formas de Pagamento</h4>
                    <div id="payment-methods-list">
                        <div class="payment-method-item">
                            <select class="payment-method-type" style="flex: 1;">
                                <option value="dinheiro">Dinheiro</option>
                                <option value="cartao_debito">Cartão Débito</option>
                                <option value="cartao_credito">Cartão Crédito</option>
                                <option value="pix">PIX</option>
                                <option value="boleto">Boleto</option>
                                <option value="credito_loja">Crédito Loja</option>
                                <option value="parcelado">Parcelado</option>
                            </select>
                            <input type="number" class="payment-method-value" placeholder="Valor" step="0.01" min="0" style="flex: 1;">
                            <select class="payment-method-parcelas" style="display: none; flex: 0.5;">
                                <option value="1">1x</option>
                                <option value="2">2x</option>
                                <option value="3">3x</option>
                                <option value="4">4x</option>
                                <option value="5">5x</option>
                                <option value="6">6x</option>
                            </select>
                            <button type="button" class="btn btn-sm btn-danger remove-payment-method"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-primary" id="add-payment-method"><i class="fas fa-plus"></i> Adicionar Forma de Pagamento</button>
                    <div style="margin-top: 10px;">
                        <p><strong>Total Pagamentos:</strong> <span id="total-payment">R$ 0,00</span></p>
                        <p><strong>Troco:</strong> <span id="change-amount" style="color: var(--success-color);">R$ 0,00</span></p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="venda-observacoes">Observações</label>
                    <textarea id="venda-observacoes" rows="2"></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" id="gerar-orcamento-btn"><i class="fas fa-file-invoice-dollar"></i> Gerar Orçamento</button>
                    <button type="button" class="btn btn-success" id="finalizar-venda-btn"><i class="fas fa-check"></i> Finalizar Venda</button>
                    <button type="button" class="btn btn-primary" id="imprimir-recibo-btn"><i class="fas fa-print"></i> Imprimir Recibo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Leitor de Código de Barras -->
    <div class="modal" id="barcode-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Leitor de Código de Barras</h3>
                <button class="modal-close" id="fechar-barcode-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="barcode-scanner">
                    <video id="barcode-video" autoplay playsinline></video>
                    <div class="barcode-overlay"></div>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <p>Ou digite o código manualmente:</p>
                    <input type="text" id="manual-barcode" placeholder="Digite o código de barras" style="width: 100%; padding: 10px; font-size: 1.2rem;">
                    <button class="btn btn-primary" id="search-barcode" style="margin-top: 10px;">Buscar Produto</button>
                </div>
                <div id="barcode-result" style="margin-top: 1rem;"></div>
            </div>
        </div>
    </div>

    <!-- Modal para Backup/Restore -->
    <div class="modal" id="backup-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Backup e Restauração</h3>
                <button class="modal-close" id="fechar-backup-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="config-section">
                    <h3><i class="fas fa-database"></i> Backup dos Dados</h3>
                    <p>Faça backup de todos os dados do sistema para um arquivo JSON.</p>
                    <div class="form-actions">
                        <button class="btn btn-warning" id="backup-json-btn"><i class="fas fa-file-export"></i> Exportar Backup (JSON)</button>
                        <button class="btn btn-primary" id="backup-csv-btn"><i class="fas fa-file-csv"></i> Exportar CSV</button>
                    </div>
                </div>

                <div class="config-section">
                    <h3><i class="fas fa-history"></i> Restaurar Dados</h3>
                    <p>Restaurar dados a partir de um backup anterior.</p>
                    <div class="form-group">
                        <label for="restore-file">Selecionar Arquivo de Backup</label>
                        <input type="file" id="restore-file" accept=".json,.csv">
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-success" id="restore-data-btn"><i class="fas fa-file-import"></i> Restaurar Dados</button>
                    </div>
                </div>

                <div class="config-section">
                    <h3><i class="fas fa-trash-alt"></i> Limpar Dados</h3>
                    <p>Limpar todos os dados do sistema (cuidado: esta ação não pode ser desfeita).</p>
                    <div class="form-actions">
                        <button class="btn btn-danger" id="clear-data-btn"><i class="fas fa-trash"></i> Limpar Todos os Dados</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recibo Térmico (oculto para impressão) -->
    <div id="thermal-receipt" class="thermal-receipt" style="display: none;">
        <div class="receipt-header">
            <div id="receipt-store-name">Ótica VisionPlus</div>
            <div id="receipt-store-address">Rua Exemplo, 123 - Centro</div>
            <div id="receipt-store-phone">(11) 99999-9999</div>
            <div id="receipt-store-cnpj">CNPJ: 00.000.000/0000-00</div>
            <div>--------------------------------</div>
        </div>
        <div class="receipt-info">
            <div>RECIBO DE VENDA</div>
            <div id="receipt-sale-id">Nº: 000001</div>
            <div id="receipt-date">Data: 01/01/2024 10:00:00</div>
            <div id="receipt-customer">Cliente: João Silva</div>
            <div>--------------------------------</div>
        </div>
        <div class="receipt-items" id="receipt-items">
            <!-- Itens serão adicionados aqui -->
        </div>
        <div class="receipt-total">
            <div>Subtotal: R$ 0,00</div>
            <div>Desconto: R$ 0,00</div>
            <div>Total: R$ 0,00</div>
            <div>Forma Pagto: Dinheiro</div>
        </div>
        <div class="receipt-footer">
            <div>--------------------------------</div>
            <div>Obrigado pela preferência!</div>
            <div>Volte sempre!</div>
            <div>--------------------------------</div>
            <div>Este documento não é nota fiscal</div>
        </div>
    </div>

    <script>
        // Sistema Completo de Gestão para Ótica - CORRIGIDO
        // Inicialização de variáveis globais
        let db;
        let currentUser = null;
        let storeConfig = {};
        let vendaItens = [];
        let currentVendaId = null;
        let barcodeScanner = null;
        let paymentMethods = [];

        // Configurações padrão
        const DEFAULT_CONFIG = {
            storeName: "Ótica VisionPlus",
            storeSlogan: "Sistema Completo de Gestão",
            storeCNPJ: "",
            storePhone: "",
            storeEmail: "",
            storeAddress: "",
            logo: "",
            taxRate: 2.5,
            warrantyDays: 90,
            printerType: "browser",
            whatsappNumber: "",
            backupAuto: "semanal",
            backupPath: "backup/"
        };

        // Usuários do sistema
        const SYSTEM_USERS = [
            { username: "admin", password: "admin123", name: "Administrador", role: "admin" },
            { username: "vendedor", password: "vendedor123", name: "Vendedor", role: "seller" }
        ];

        // Nome do banco de dados
        const DB_NAME = 'OticaVisionPlusDB';
        const DB_VERSION = 2;

        // Object stores
        const STORES = {
            CLIENTES: 'clientes',
            PRODUTOS: 'produtos',
            ORCAMENTOS: 'orcamentos',
            VENDAS: 'vendas',
            SERVICOS: 'servicos',
            CONFIG: 'config',
            USERS: 'users',
            BACKUPS: 'backups'
        };

        // Inicialização do sistema
        document.addEventListener('DOMContentLoaded', function() {
            initLogin();
            initEventListeners();
            updateDateTime();
            setInterval(updateDateTime, 1000);
        });

        // Inicializar tela de login
        function initLogin() {
            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                
                authenticateUser(username, password);
            });
        }

        // Autenticar usuário
        function authenticateUser(username, password) {
            const user = SYSTEM_USERS.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                showMainApp();
            } else {
                alert('Usuário ou senha incorretos!');
            }
        }

        // Mostrar aplicação principal
        function showMainApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            document.getElementById('current-user').textContent = currentUser.name;
            
            initDB();
        }

        // Atualizar data e hora
        function updateDateTime() {
            const now = new Date();
            const dateTimeStr = now.toLocaleDateString('pt-BR') + ' ' + now.toLocaleTimeString('pt-BR');
            const dateTimeElement = document.getElementById('current-date-time');
            if (dateTimeElement) {
                dateTimeElement.textContent = dateTimeStr;
            }
            
            // Atualizar ano no footer
            document.getElementById('ano-atual').textContent = now.getFullYear();
        }

        // Inicializar banco de dados
        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = function(event) {
                console.error('Erro ao abrir o banco de dados:', event.target.error);
                alert('Erro ao inicializar o banco de dados. Verifique o console para mais detalhes.');
            };

            request.onsuccess = function(event) {
                db = event.target.result;
                console.log('Banco de dados inicializado com sucesso');
                loadConfig();
                loadInitialData();
                checkLowStock();
                checkBirthdays();
            };

            request.onupgradeneeded = function(event) {
                const db = event.target.result;

                // Criar object stores
                if (!db.objectStoreNames.contains(STORES.CLIENTES)) {
                    const clientesStore = db.createObjectStore(STORES.CLIENTES, { keyPath: 'id', autoIncrement: true });
                    clientesStore.createIndex('nome', 'nome', { unique: false });
                    clientesStore.createIndex('telefone', 'telefone', { unique: false });
                    clientesStore.createIndex('aniversario', 'dataNascimento', { unique: false });
                }

                if (!db.objectStoreNames.contains(STORES.PRODUTOS)) {
                    const produtosStore = db.createObjectStore(STORES.PRODUTOS, { keyPath: 'id', autoIncrement: true });
                    produtosStore.createIndex('categoria', 'categoria', { unique: false });
                    produtosStore.createIndex('codigo', 'codigo', { unique: true });
                    produtosStore.createIndex('codigoBarras', 'codigoBarras', { unique: true });
                }

                if (!db.objectStoreNames.contains(STORES.ORCAMENTOS)) {
                    const orcamentosStore = db.createObjectStore(STORES.ORCAMENTOS, { keyPath: 'id', autoIncrement: true });
                    orcamentosStore.createIndex('clienteId', 'clienteId', { unique: false });
                    orcamentosStore.createIndex('data', 'data', { unique: false });
                }

                if (!db.objectStoreNames.contains(STORES.VENDAS)) {
                    const vendasStore = db.createObjectStore(STORES.VENDAS, { keyPath: 'id', autoIncrement: true });
                    vendasStore.createIndex('clienteId', 'clienteId', { unique: false });
                    vendasStore.createIndex('data', 'data', { unique: false });
                }

                if (!db.objectStoreNames.contains(STORES.SERVICOS)) {
                    const servicosStore = db.createObjectStore(STORES.SERVICOS, { keyPath: 'id', autoIncrement: true });
                    servicosStore.createIndex('clienteId', 'clienteId', { unique: false });
                    servicosStore.createIndex('status', 'status', { unique: false });
                }

                if (!db.objectStoreNames.contains(STORES.CONFIG)) {
                    const configStore = db.createObjectStore(STORES.CONFIG, { keyPath: 'id' });
                }

                if (!db.objectStoreNames.contains(STORES.USERS)) {
                    const usersStore = db.createObjectStore(STORES.USERS, { keyPath: 'id', autoIncrement: true });
                    usersStore.createIndex('username', 'username', { unique: true });
                }

                if (!db.objectStoreNames.contains(STORES.BACKUPS)) {
                    const backupsStore = db.createObjectStore(STORES.BACKUPS, { keyPath: 'id', autoIncrement: true });
                    backupsStore.createIndex('data', 'data', { unique: false });
                }

                console.log('Estrutura do banco de dados criada com sucesso');
                
                // Inserir usuários padrão
                const transaction = event.target.transaction;
                const usersStore = transaction.objectStore(STORES.USERS);
                SYSTEM_USERS.forEach(user => {
                    usersStore.add(user);
                });
            };
        }

        // Carregar configurações
        function loadConfig() {
            const transaction = db.transaction([STORES.CONFIG], 'readonly');
            const store = transaction.objectStore(STORES.CONFIG);
            const request = store.get(1);

            request.onsuccess = function() {
                if (request.result) {
                    storeConfig = request.result;
                    applyConfig();
                } else {
                    // Configurações padrão
                    storeConfig = { id: 1, ...DEFAULT_CONFIG };
                    saveConfig();
                }
            };
        }

        // Aplicar configurações
        function applyConfig() {
            // Aplicar no header
            document.getElementById('store-name').textContent = storeConfig.storeName;
            document.getElementById('store-slogan').textContent = storeConfig.storeSlogan;
            document.getElementById('footer-text').innerHTML = `${storeConfig.storeName} &copy; <span id="ano-atual"></span> - Sistema Completo de Gestão`;
            
            // Aplicar na tela de login
            const loginLogo = document.getElementById('login-logo-img');
            if (storeConfig.logo) {
                loginLogo.src = storeConfig.logo;
                loginLogo.style.display = 'block';
            }
            
            // Aplicar no header
            const headerLogo = document.getElementById('header-logo');
            if (storeConfig.logo) {
                headerLogo.src = storeConfig.logo;
                headerLogo.style.display = 'block';
            }
            
            // Atualizar campos de configuração
            if (document.getElementById('config-nome')) {
                document.getElementById('config-nome').value = storeConfig.storeName;
                document.getElementById('config-slogan').value = storeConfig.storeSlogan;
                document.getElementById('config-cnpj').value = storeConfig.storeCNPJ;
                document.getElementById('config-telefone').value = storeConfig.storePhone;
                document.getElementById('config-email').value = storeConfig.storeEmail;
                document.getElementById('config-endereco').value = storeConfig.storeAddress;
                document.getElementById('config-taxa-juros').value = storeConfig.taxRate;
                document.getElementById('config-dias-garantia').value = storeConfig.warrantyDays;
                document.getElementById('config-impressora').value = storeConfig.printerType;
                document.getElementById('config-whatsapp').value = storeConfig.whatsappNumber;
                document.getElementById('config-backup-auto').value = storeConfig.backupAuto;
                document.getElementById('config-backup-path').value = storeConfig.backupPath;
                
                // Atualizar logo na configuração
                const logoContainer = document.getElementById('logo-upload-container');
                if (storeConfig.logo) {
                    logoContainer.innerHTML = `<img src="${storeConfig.logo}" alt="Logo da Loja">`;
                }
            }
        }

        // Salvar configurações
        function saveConfig() {
            try {
                const transaction = db.transaction([STORES.CONFIG], 'readwrite');
                const store = transaction.objectStore(STORES.CONFIG);
                const request = store.put(storeConfig);
                
                request.onsuccess = function() {
                    alert('Configurações salvas com sucesso!');
                    applyConfig();
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao salvar configurações:', event.target.error);
                    alert('Erro ao salvar configurações.');
                };
            } catch (error) {
                console.error('Erro na transação:', error);
                alert('Erro ao salvar configurações.');
            }
        }

        // Carregar dados iniciais
        function loadInitialData() {
            updateDashboard();
            loadClientes();
            loadOrcamentos();
            loadVendas();
            loadProdutos();
            loadServicos();
            loadClientesForSelect();
            loadProdutosForSelect();
        }

        // Atualizar dashboard
        function updateDashboard() {
            const hoje = new Date().toISOString().split('T')[0];
            
            // Estatísticas
            countRecords(STORES.ORCAMENTOS, 'data', hoje, 'orcamentos-hoje');
            countRecords(STORES.VENDAS, 'data', hoje, 'vendas-hoje');
            
            // Faturamento do dia
            calculateDailyRevenue(hoje);
            
            // Total de clientes
            countAllRecords(STORES.CLIENTES, 'total-clientes');
            
            // Orçamentos recentes
            loadOrcamentosRecentes();
        }

        // Contar registros
        function countRecords(storeName, indexName, key, elementId) {
            try {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const index = store.index(indexName);
                const range = IDBKeyRange.only(key);
                const request = index.count(range);
                
                request.onsuccess = function() {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = request.result;
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao contar registros:', event.target.error);
                };
            } catch (error) {
                console.error('Erro na contagem de registros:', error);
            }
        }

        // Contar todos os registros
        function countAllRecords(storeName, elementId) {
            try {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.count();
                
                request.onsuccess = function() {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = request.result;
                    }
                };
            } catch (error) {
                console.error('Erro ao contar todos os registros:', error);
            }
        }

        // Calcular faturamento diário
        function calculateDailyRevenue(date) {
            try {
                const transaction = db.transaction([STORES.VENDAS], 'readonly');
                const store = transaction.objectStore(STORES.VENDAS);
                const index = store.index('data');
                const range = IDBKeyRange.only(date);
                const request = index.openCursor(range);
                
                let total = 0;
                
                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        total += cursor.value.valorTotal || 0;
                        cursor.continue();
                    } else {
                        const element = document.getElementById('faturamento-hoje');
                        if (element) {
                            element.textContent = formatCurrency(total);
                        }
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao calcular faturamento:', event.target.error);
                };
            } catch (error) {
                console.error('Erro no cálculo do faturamento:', error);
            }
        }

        // Verificar estoque baixo
        function checkLowStock() {
            try {
                const transaction = db.transaction([STORES.PRODUTOS], 'readonly');
                const store = transaction.objectStore(STORES.PRODUTOS);
                const request = store.openCursor();
                
                let lowStockCount = 0;
                let alertHtml = '';
                
                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        const produto = cursor.value;
                        if (produto.estoqueMinimo && produto.estoque <= produto.estoqueMinimo) {
                            lowStockCount++;
                            alertHtml += `
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <div>
                                        <strong>Estoque baixo:</strong> ${produto.nome} (${produto.estoque} unidades)
                                        <br><small>Código: ${produto.codigo} | Mínimo: ${produto.estoqueMinimo}</small>
                                    </div>
                                </div>
                            `;
                        }
                        cursor.continue();
                    } else {
                        document.getElementById('estoque-baixo-count').textContent = lowStockCount;
                        
                        const alertsContainer = document.getElementById('dashboard-alerts');
                        if (lowStockCount > 0) {
                            alertsContainer.innerHTML = alertHtml;
                        } else {
                            alertsContainer.innerHTML = '';
                        }
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao verificar estoque:', event.target.error);
                };
            } catch (error) {
                console.error('Erro na verificação de estoque:', error);
            }
        }

        // Verificar aniversariantes do mês
        function checkBirthdays() {
            try {
                const hoje = new Date();
                const mesAtual = hoje.getMonth() + 1;
                
                const transaction = db.transaction([STORES.CLIENTES], 'readonly');
                const store = transaction.objectStore(STORES.CLIENTES);
                const index = store.index('aniversario');
                const request = index.openCursor();
                
                let birthdayCount = 0;
                let birthdayHtml = '';
                
                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        const cliente = cursor.value;
                        if (cliente.dataNascimento) {
                            const nascimento = new Date(cliente.dataNascimento);
                            if (nascimento.getMonth() + 1 === mesAtual) {
                                birthdayCount++;
                                const dia = nascimento.getDate();
                                birthdayHtml += `
                                    <div class="birthday-card">
                                        <div class="birthday-icon">
                                            <i class="fas fa-birthday-cake"></i>
                                        </div>
                                        <div class="birthday-info">
                                            <h4>${cliente.nome}</h4>
                                            <p>Aniversário: ${dia.toString().padStart(2, '0')}/${mesAtual.toString().padStart(2, '0')}</p>
                                            <p>Telefone: ${cliente.telefone}</p>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                        cursor.continue();
                    } else {
                        const container = document.getElementById('birthdays-container');
                        const list = document.getElementById('birthdays-list');
                        
                        if (container && list) {
                            if (birthdayCount > 0) {
                                container.style.display = 'block';
                                list.innerHTML = birthdayHtml;
                            } else {
                                container.style.display = 'none';
                            }
                        }
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao verificar aniversariantes:', event.target.error);
                };
            } catch (error) {
                console.error('Erro na verificação de aniversariantes:', error);
            }
        }

        // Carregar clientes
        function loadClientes() {
            try {
                const tbody = document.getElementById('clientes-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                const transaction = db.transaction([STORES.CLIENTES], 'readonly');
                const store = transaction.objectStore(STORES.CLIENTES);
                const request = store.openCursor();

                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        const cliente = cursor.value;
                        const row = document.createElement('tr');
                        
                        // Calcular aniversário
                        let aniversario = '-';
                        if (cliente.dataNascimento) {
                            const nascimento = new Date(cliente.dataNascimento);
                            aniversario = `${nascimento.getDate().toString().padStart(2, '0')}/${(nascimento.getMonth() + 1).toString().padStart(2, '0')}`;
                        }
                        
                        row.innerHTML = `
                            <td>${cliente.id}</td>
                            <td>${cliente.nome}</td>
                            <td>${cliente.telefone}</td>
                            <td>${cliente.email || '-'}</td>
                            <td>${cliente.dataNascimento ? new Date(cliente.dataNascimento).toLocaleDateString('pt-BR') : '-'}</td>
                            <td>${aniversario}</td>
                            <td>
                                <button class="btn btn-sm" onclick="editarCliente(${cliente.id})"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="excluirCliente(${cliente.id})"><i class="fas fa-trash"></i></button>
                                <button class="btn btn-sm btn-success" onclick="enviarWhatsAppCliente(${cliente.id})"><i class="fab fa-whatsapp"></i></button>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                        cursor.continue();
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao carregar clientes:', event.target.error);
                };
            } catch (error) {
                console.error('Erro no carregamento de clientes:', error);
                alert('Erro ao carregar clientes.');
            }
        }

        // Carregar clientes para select
        function loadClientesForSelect() {
            try {
                const select = document.getElementById('venda-cliente');
                if (!select) return;
                
                select.innerHTML = '<option value="">Selecione um cliente</option>';
                
                const transaction = db.transaction([STORES.CLIENTES], 'readonly');
                const store = transaction.objectStore(STORES.CLIENTES);
                const request = store.openCursor();

                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        const cliente = cursor.value;
                        const option = document.createElement('option');
                        option.value = cliente.id;
                        option.textContent = `${cliente.nome} - ${cliente.telefone}`;
                        select.appendChild(option);
                        cursor.continue();
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao carregar clientes para select:', event.target.error);
                };
            } catch (error) {
                console.error('Erro no carregamento de clientes para select:', error);
            }
        }

        // Carregar produtos para select
        function loadProdutosForSelect() {
            try {
                const select = document.getElementById('venda-produto');
                if (!select) return;
                
                select.innerHTML = '<option value="">Selecione um produto</option>';
                
                const transaction = db.transaction([STORES.PRODUTOS], 'readonly');
                const store = transaction.objectStore(STORES.PRODUTOS);
                const request = store.openCursor();

                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        const produto = cursor.value;
                        if (produto.estoque > 0) {
                            const option = document.createElement('option');
                            option.value = produto.id;
                            option.textContent = `${produto.codigo} - ${produto.nome} - R$ ${formatCurrency(produto.precoVenda)} (Estoque: ${produto.estoque})`;
                            option.dataset.preco = produto.precoVenda;
                            select.appendChild(option);
                        }
                        cursor.continue();
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao carregar produtos para select:', event.target.error);
                };
            } catch (error) {
                console.error('Erro no carregamento de produtos para select:', error);
            }
        }

        // Carregar orçamentos
        function loadOrcamentos() {
            try {
                const tbody = document.getElementById('orcamentos-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                const transaction = db.transaction([STORES.ORCAMENTOS, STORES.CLIENTES], 'readonly');
                const orcamentosStore = transaction.objectStore(STORES.ORCAMENTOS);
                const clientesStore = transaction.objectStore(STORES.CLIENTES);
                const request = orcamentosStore.openCursor();

                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        const orcamento = cursor.value;
                        
                        // Buscar cliente
                        const clienteRequest = clientesStore.get(orcamento.clienteId);
                        
                        clienteRequest.onsuccess = function() {
                            const cliente = clienteRequest.result;
                            const row = document.createElement('tr');
                            
                            row.innerHTML = `
                                <td>${orcamento.id}</td>
                                <td>${cliente ? cliente.nome : 'Cliente não encontrado'}</td>
                                <td>${new Date(orcamento.data).toLocaleDateString('pt-BR')}</td>
                                <td>${formatCurrency(orcamento.valorTotal || 0)}</td>
                                <td><span class="status ${getStatusClass(orcamento.status)}">${orcamento.status || 'Pendente'}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-success" onclick="enviarWhatsAppOrcamento(${orcamento.id})">
                                        <i class="fab fa-whatsapp"></i> Enviar
                                    </button>
                                </td>
                                <td>
                                    <button class="btn btn-sm" onclick="visualizarOrcamento(${orcamento.id})"><i class="fas fa-eye"></i></button>
                                    <button class="btn btn-sm btn-success" onclick="converterOrcamento(${orcamento.id})"><i class="fas fa-shopping-cart"></i></button>
                                    <button class="btn btn-sm btn-danger" onclick="excluirOrcamento(${orcamento.id})"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                            
                            tbody.appendChild(row);
                        };
                        
                        cursor.continue();
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao carregar orçamentos:', event.target.error);
                };
            } catch (error) {
                console.error('Erro no carregamento de orçamentos:', error);
            }
        }

        // Carregar orçamentos recentes para dashboard
        function loadOrcamentosRecentes() {
            try {
                const tbody = document.getElementById('orcamentos-recentes-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                const transaction = db.transaction([STORES.ORCAMENTOS, STORES.CLIENTES], 'readonly');
                const orcamentosStore = transaction.objectStore(STORES.ORCAMENTOS);
                const clientesStore = transaction.objectStore(STORES.CLIENTES);
                const index = orcamentosStore.index('data');
                const request = index.openCursor(null, 'prev');
                let count = 0;

                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor && count < 5) {
                        const orcamento = cursor.value;
                        
                        // Buscar cliente
                        const clienteRequest = clientesStore.get(orcamento.clienteId);
                        
                        clienteRequest.onsuccess = function() {
                            const cliente = clienteRequest.result;
                            const row = document.createElement('tr');
                            
                            row.innerHTML = `
                                <td>${orcamento.id}</td>
                                <td>${cliente ? cliente.nome : 'Cliente não encontrado'}</td>
                                <td>${new Date(orcamento.data).toLocaleDateString('pt-BR')}</td>
                                <td>${formatCurrency(orcamento.valorTotal || 0)}</td>
                                <td><span class="status ${getStatusClass(orcamento.status)}">${orcamento.status || 'Pendente'}</span></td>
                                <td>
                                    <button class="btn btn-sm" onclick="visualizarOrcamento(${orcamento.id})"><i class="fas fa-eye"></i></button>
                                </td>
                            `;
                            
                            tbody.appendChild(row);
                        };
                        
                        count++;
                        cursor.continue();
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao carregar orçamentos recentes:', event.target.error);
                };
            } catch (error) {
                console.error('Erro no carregamento de orçamentos recentes:', error);
            }
        }

        // Carregar produtos
        function loadProdutos() {
            try {
                const tbody = document.getElementById('produtos-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                let totalArmacoes = 0;
                let totalLentes = 0;
                let totalSolucoes = 0;
                let totalProdutos = 0;

                const transaction = db.transaction([STORES.PRODUTOS], 'readonly');
                const store = transaction.objectStore(STORES.PRODUTOS);
                const request = store.openCursor();

                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        const produto = cursor.value;
                        const row = document.createElement('tr');
                        
                        // Atualizar contadores
                        totalProdutos++;
                        switch(produto.categoria) {
                            case 'armacao':
                                totalArmacoes += produto.estoque || 0;
                                break;
                            case 'lente':
                                totalLentes += produto.estoque || 0;
                                break;
                            case 'solucao':
                                totalSolucoes += produto.estoque || 0;
                                break;
                        }
                        
                        // Verificar estoque baixo
                        if (produto.estoqueMinimo && produto.estoque <= produto.estoqueMinimo) {
                            row.style.backgroundColor = '#fef9e7';
                        }
                        
                        // Mostrar imagem do produto
                        let imagem = '<i class="fas fa-box" style="color: #ccc;"></i>';
                        if (produto.imagem) {
                            imagem = `<img src="${produto.imagem}" alt="${produto.nome}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">`;
                        }
                        
                        // Mostrar código de barras
                        let codigoBarras = '-';
                        if (produto.codigoBarras) {
                            codigoBarras = `<small>${produto.codigoBarras}</small>`;
                        }
                        
                        row.innerHTML = `
                            <td>${produto.codigo}</td>
                            <td>${imagem}</td>
                            <td>${produto.nome}</td>
                            <td>${formatarCategoria(produto.categoria)}</td>
                            <td>${produto.estoque}</td>
                            <td>${formatCurrency(produto.precoVenda || 0)}</td>
                            <td>${codigoBarras}</td>
                            <td>
                                <button class="btn btn-sm" onclick="editarProduto(${produto.id})"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="excluirProduto(${produto.id})"><i class="fas fa-trash"></i></button>
                                <button class="btn btn-sm btn-warning" onclick="gerarCodigoBarras(${produto.id})"><i class="fas fa-barcode"></i></button>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                        cursor.continue();
                    } else {
                        // Atualizar cards de resumo
                        const totalArmacoesEl = document.getElementById('total-armacoes');
                        const totalLentesEl = document.getElementById('total-lentes');
                        const totalSolucoesEl = document.getElementById('total-solucoes');
                        const totalProdutosEl = document.getElementById('total-produtos');
                        
                        if (totalArmacoesEl) totalArmacoesEl.textContent = totalArmacoes;
                        if (totalLentesEl) totalLentesEl.textContent = totalLentes;
                        if (totalSolucoesEl) totalSolucoesEl.textContent = totalSolucoes;
                        if (totalProdutosEl) totalProdutosEl.textContent = totalProdutos;
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao carregar produtos:', event.target.error);
                };
            } catch (error) {
                console.error('Erro no carregamento de produtos:', error);
            }
        }

        // Carregar vendas
        function loadVendas() {
            try {
                const tbody = document.getElementById('vendas-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                const transaction = db.transaction([STORES.VENDAS, STORES.CLIENTES], 'readonly');
                const vendasStore = transaction.objectStore(STORES.VENDAS);
                const clientesStore = transaction.objectStore(STORES.CLIENTES);
                const request = vendasStore.openCursor();

                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        const venda = cursor.value;
                        
                        // Buscar cliente
                        const clienteRequest = clientesStore.get(venda.clienteId);
                        
                        clienteRequest.onsuccess = function() {
                            const cliente = clienteRequest.result;
                            const row = document.createElement('tr');
                            
                            // Formatar formas de pagamento (agora múltiplas)
                            let formasPagamento = 'Não informado';
                            if (venda.formasPagamento && venda.formasPagamento.length > 0) {
                                formasPagamento = venda.formasPagamento.map(fp => {
                                    return `${formatPaymentMethod(fp.tipo)}: ${formatCurrency(fp.valor)}`;
                                }).join(', ');
                            } else if (venda.formaPagamento) {
                                // Para compatibilidade com vendas antigas
                                formasPagamento = formatPaymentMethod(venda.formaPagamento);
                            }
                            
                            row.innerHTML = `
                                <td>${venda.id}</td>
                                <td>${cliente ? cliente.nome : 'Consumidor'}</td>
                                <td>${new Date(venda.data).toLocaleDateString('pt-BR')}</td>
                                <td>${formatCurrency(venda.valorTotal || 0)}</td>
                                <td>${formasPagamento}</td>
                                <td><span class="status ${getStatusClass(venda.status)}">${venda.status || 'Concluída'}</span></td>
                                <td>
                                    <button class="btn btn-sm" onclick="visualizarVenda(${venda.id})"><i class="fas fa-eye"></i></button>
                                    <button class="btn btn-sm btn-primary" onclick="imprimirReciboVenda(${venda.id})"><i class="fas fa-print"></i></button>
                                    <button class="btn btn-sm btn-danger" onclick="excluirVenda(${venda.id})"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                            
                            tbody.appendChild(row);
                        };
                        
                        cursor.continue();
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao carregar vendas:', event.target.error);
                };
            } catch (error) {
                console.error('Erro no carregamento de vendas:', error);
            }
        }

        // Carregar serviços (pós-venda)
        function loadServicos() {
            try {
                const tbody = document.getElementById('posvenda-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                const transaction = db.transaction([STORES.SERVICOS, STORES.CLIENTES], 'readonly');
                const servicosStore = transaction.objectStore(STORES.SERVICOS);
                const clientesStore = transaction.objectStore(STORES.CLIENTES);
                const request = servicosStore.openCursor();

                let pendentesCount = 0;
                let aguardandoCount = 0;
                let garantiasCount = 0;
                let reclamacoesCount = 0;

                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        const servico = cursor.value;
                        
                        // Contar por status
                        if (servico.status === 'Pendente') pendentesCount++;
                        if (servico.status === 'Aguardando Retirada') aguardandoCount++;
                        if (servico.tipo === 'Garantia') garantiasCount++;
                        if (servico.tipo === 'Reclamação') reclamacoesCount++;
                        
                        // Buscar cliente
                        const clienteRequest = clientesStore.get(servico.clienteId);
                        
                        clienteRequest.onsuccess = function() {
                            const cliente = clienteRequest.result;
                            const row = document.createElement('tr');
                            
                            row.innerHTML = `
                                <td>${servico.id}</td>
                                <td>${cliente ? cliente.nome : 'Cliente não encontrado'}</td>
                                <td>${servico.tipo || 'Serviço'}</td>
                                <td>${new Date(servico.dataSolicitacao).toLocaleDateString('pt-BR')}</td>
                                <td>${servico.previsaoEntrega ? new Date(servico.previsaoEntrega).toLocaleDateString('pt-BR') : '-'}</td>
                                <td><span class="status ${getStatusClass(servico.status)}">${servico.status || 'Pendente'}</span></td>
                                <td>
                                    <button class="btn btn-sm" onclick="visualizarServico(${servico.id})"><i class="fas fa-eye"></i></button>
                                    <button class="btn btn-sm btn-success" onclick="atualizarStatusServico(${servico.id})"><i class="fas fa-check"></i></button>
                                </td>
                            `;
                            
                            tbody.appendChild(row);
                        };
                        
                        cursor.continue();
                    } else {
                        // Atualizar cards de resumo
                        const servicosPendentesEl = document.getElementById('servicos-pendentes');
                        const aguardandoRetiradaEl = document.getElementById('aguardando-retirada');
                        const garantiasAtivasEl = document.getElementById('garantias-ativas');
                        const reclamacoesEl = document.getElementById('reclamacoes');
                        
                        if (servicosPendentesEl) servicosPendentesEl.textContent = pendentesCount;
                        if (aguardandoRetiradaEl) aguardandoRetiradaEl.textContent = aguardandoCount;
                        if (garantiasAtivasEl) garantiasAtivasEl.textContent = garantiasCount;
                        if (reclamacoesEl) reclamacoesEl.textContent = reclamacoesCount;
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao carregar serviços:', event.target.error);
                };
            } catch (error) {
                console.error('Erro no carregamento de serviços:', error);
            }
        }

        // Inicializar event listeners
        function initEventListeners() {
            // Navegação
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Atualizar navegação ativa
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Mostrar página correspondente
                    const pageId = this.getAttribute('data-page');
                    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                    document.getElementById(`${pageId}-page`).classList.add('active');
                    
                    // Atualizar dados da página
                    if (pageId === 'dashboard') {
                        updateDashboard();
                        checkLowStock();
                        checkBirthdays();
                    } else if (pageId === 'clientes') {
                        loadClientes();
                    } else if (pageId === 'orcamentos') {
                        loadOrcamentos();
                    } else if (pageId === 'vendas') {
                        loadVendas();
                    } else if (pageId === 'produtos') {
                        loadProdutos();
                    } else if (pageId === 'posvenda') {
                        loadServicos();
                    } else if (pageId === 'configuracoes') {
                        applyConfig();
                    }
                });
            });

            // Menu toggle mobile
            const navToggle = document.querySelector('.nav-toggle');
            if (navToggle) {
                navToggle.addEventListener('click', function() {
                    const navMenu = document.querySelector('.nav-menu');
                    if (navMenu) {
                        navMenu.classList.toggle('active');
                    }
                });
            }

            // Logout
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    if (confirm('Deseja realmente sair do sistema?')) {
                        currentUser = null;
                        document.getElementById('app-container').style.display = 'none';
                        document.getElementById('login-screen').style.display = 'flex';
                        document.getElementById('login-form').reset();
                    }
                });
            }

            // Backup
            const backupBtn = document.getElementById('backup-btn');
            if (backupBtn) {
                backupBtn.addEventListener('click', function() {
                    openBackupModal();
                });
            }

            // Modal de cliente
            const novoClienteBtn = document.getElementById('novo-cliente-btn');
            if (novoClienteBtn) {
                novoClienteBtn.addEventListener('click', openClienteModal);
            }
            
            const fecharClienteModal = document.getElementById('fechar-cliente-modal');
            if (fecharClienteModal) {
                fecharClienteModal.addEventListener('click', closeClienteModal);
            }
            
            const cancelarCliente = document.getElementById('cancelar-cliente');
            if (cancelarCliente) {
                cancelarCliente.addEventListener('click', closeClienteModal);
            }
            
            const formCliente = document.getElementById('form-cliente');
            if (formCliente) {
                formCliente.addEventListener('submit', saveCliente);
            }

            // Modal de produto
            const novoProdutoBtn = document.getElementById('novo-produto-btn');
            if (novoProdutoBtn) {
                novoProdutoBtn.addEventListener('click', openProdutoModal);
            }
            
            const fecharProdutoModal = document.getElementById('fechar-produto-modal');
            if (fecharProdutoModal) {
                fecharProdutoModal.addEventListener('click', closeProdutoModal);
            }
            
            const cancelarProduto = document.getElementById('cancelar-produto');
            if (cancelarProduto) {
                cancelarProduto.addEventListener('click', closeProdutoModal);
            }
            
            const formProduto = document.getElementById('form-produto');
            if (formProduto) {
                formProduto.addEventListener('submit', saveProduto);
            }
            
            const productImageContainer = document.getElementById('product-image-upload-container');
            if (productImageContainer) {
                productImageContainer.addEventListener('click', function() {
                    const upload = document.getElementById('product-image-upload');
                    if (upload) upload.click();
                });
            }
            
            const productImageUpload = document.getElementById('product-image-upload');
            if (productImageUpload) {
                productImageUpload.addEventListener('change', handleProductImageUpload);
            }
            
            const generateBarcodeBtn = document.getElementById('generate-barcode');
            if (generateBarcodeBtn) {
                generateBarcodeBtn.addEventListener('click', generateBarcode);
            }
            
            const scanProdutoBtn = document.getElementById('scan-produto-btn');
            if (scanProdutoBtn) {
                scanProdutoBtn.addEventListener('click', openBarcodeScanner);
            }

            // Modal de venda
            const novaVendaBtn = document.getElementById('nova-venda-btn');
            if (novaVendaBtn) {
                novaVendaBtn.addEventListener('click', openVendaModal);
            }
            
            const quickSaleBtn = document.getElementById('quick-sale-btn');
            if (quickSaleBtn) {
                quickSaleBtn.addEventListener('click', openVendaModal);
            }
            
            const newBudgetBtn = document.getElementById('new-budget-btn');
            if (newBudgetBtn) {
                newBudgetBtn.addEventListener('click', openVendaModal);
            }
            
            const scanVendaBtn = document.getElementById('scan-venda-btn');
            if (scanVendaBtn) {
                scanVendaBtn.addEventListener('click', openBarcodeScanner);
            }
            
            const fecharVendaModal = document.getElementById('fechar-venda-modal');
            if (fecharVendaModal) {
                fecharVendaModal.addEventListener('click', closeVendaModal);
            }
            
            const adicionarProdutoVenda = document.getElementById('adicionar-produto-venda');
            if (adicionarProdutoVenda) {
                adicionarProdutoVenda.addEventListener('click', addProductToVenda);
            }
            
            const vendaDescontoValor = document.getElementById('venda-desconto-valor');
            if (vendaDescontoValor) {
                vendaDescontoValor.addEventListener('input', updateVendaTotals);
            }
            
            const gerarOrcamentoBtn = document.getElementById('gerar-orcamento-btn');
            if (gerarOrcamentoBtn) {
                gerarOrcamentoBtn.addEventListener('click', gerarOrcamentoFromVenda);
            }
            
            const finalizarVendaBtn = document.getElementById('finalizar-venda-btn');
            if (finalizarVendaBtn) {
                finalizarVendaBtn.addEventListener('click', finalizarVenda);
            }
            
            const imprimirReciboBtn = document.getElementById('imprimir-recibo-btn');
            if (imprimirReciboBtn) {
                imprimirReciboBtn.addEventListener('click', imprimirRecibo);
            }
            
            const novoClienteVenda = document.getElementById('novo-cliente-venda');
            if (novoClienteVenda) {
                novoClienteVenda.addEventListener('click', function() {
                    closeVendaModal();
                    openClienteModal();
                });
            }
            
            const scanVendaModal = document.getElementById('scan-venda-modal');
            if (scanVendaModal) {
                scanVendaModal.addEventListener('click', function() {
                    closeVendaModal();
                    openBarcodeScanner('venda');
                });
            }
            
            // Múltiplas formas de pagamento
            const addPaymentMethodBtn = document.getElementById('add-payment-method');
            if (addPaymentMethodBtn) {
                addPaymentMethodBtn.addEventListener('click', addPaymentMethod);
            }
            
            // Configurações
            const saveConfigBtn = document.getElementById('save-config-btn');
            if (saveConfigBtn) {
                saveConfigBtn.addEventListener('click', saveConfigFromForm);
            }
            
            const logoUploadContainer = document.getElementById('logo-upload-container');
            if (logoUploadContainer) {
                logoUploadContainer.addEventListener('click', function() {
                    const logoUpload = document.getElementById('logo-upload');
                    if (logoUpload) logoUpload.click();
                });
            }
            
            const logoUpload = document.getElementById('logo-upload');
            if (logoUpload) {
                logoUpload.addEventListener('change', handleLogoUpload);
            }
            
            const backupNowBtn = document.getElementById('backup-now-btn');
            if (backupNowBtn) {
                backupNowBtn.addEventListener('click', createBackup);
            }
            
            const restoreBackupBtn = document.getElementById('restore-backup-btn');
            if (restoreBackupBtn) {
                restoreBackupBtn.addEventListener('click', openBackupModal);
            }

            // Backup modal
            const fecharBackupModal = document.getElementById('fechar-backup-modal');
            if (fecharBackupModal) {
                fecharBackupModal.addEventListener('click', closeBackupModal);
            }
            
            const backupJsonBtn = document.getElementById('backup-json-btn');
            if (backupJsonBtn) {
                backupJsonBtn.addEventListener('click', exportBackupJSON);
            }
            
            const backupCsvBtn = document.getElementById('backup-csv-btn');
            if (backupCsvBtn) {
                backupCsvBtn.addEventListener('click', exportBackupCSV);
            }
            
            const restoreDataBtn = document.getElementById('restore-data-btn');
            if (restoreDataBtn) {
                restoreDataBtn.addEventListener('click', restoreBackup);
            }
            
            const clearDataBtn = document.getElementById('clear-data-btn');
            if (clearDataBtn) {
                clearDataBtn.addEventListener('click', clearAllData);
            }

            // Barcode modal
            const fecharBarcodeModal = document.getElementById('fechar-barcode-modal');
            if (fecharBarcodeModal) {
                fecharBarcodeModal.addEventListener('click', closeBarcodeModal);
            }
            
            const searchBarcodeBtn = document.getElementById('search-barcode');
            if (searchBarcodeBtn) {
                searchBarcodeBtn.addEventListener('click', searchProductByBarcode);
            }
            
            const manualBarcode = document.getElementById('manual-barcode');
            if (manualBarcode) {
                manualBarcode.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchProductByBarcode();
                    }
                });
            }

            // Relatórios
            const relatorioPeriodo = document.getElementById('relatorio-periodo');
            if (relatorioPeriodo) {
                relatorioPeriodo.addEventListener('change', toggleCustomDateRange);
            }
            
            const gerarRelatorioCustom = document.getElementById('gerar-relatorio-custom');
            if (gerarRelatorioCustom) {
                gerarRelatorioCustom.addEventListener('click', gerarRelatorioPersonalizado);
            }
        }

        // Funções auxiliares
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
        }

        function getStatusClass(status) {
            if (!status) return 'status-pendente';
            
            switch(status.toLowerCase()) {
                case 'concluído':
                case 'concluida':
                case 'entregue':
                case 'pago':
                    return 'status-concluido';
                case 'cancelado':
                case 'cancelada':
                    return 'status-cancelado';
                case 'aguardando retirada':
                case 'aguardando':
                    return 'status-entregue';
                default:
                    return 'status-pendente';
            }
        }

        function formatarCategoria(categoria) {
            const categorias = {
                'armacao': 'Armação',
                'lente': 'Lente',
                'solucao': 'Solução',
                'acessorio': 'Acessório',
                'oculos_sol': 'Óculos de Sol',
                'lente_contato': 'Lente de Contato'
            };
            return categorias[categoria] || categoria;
        }

        function formatPaymentMethod(method) {
            const methods = {
                'dinheiro': 'Dinheiro',
                'cartao_debito': 'Cartão Débito',
                'cartao_credito': 'Cartão Crédito',
                'pix': 'PIX',
                'boleto': 'Boleto',
                'credito_loja': 'Crédito Loja',
                'parcelado': 'Parcelado'
            };
            return methods[method] || method;
        }

        // Funções para clientes
        function openClienteModal() {
            const modal = document.getElementById('cliente-modal');
            if (modal) {
                modal.classList.add('active');
            }
            const form = document.getElementById('form-cliente');
            if (form) {
                form.reset();
            }
        }

        function closeClienteModal() {
            const modal = document.getElementById('cliente-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function saveCliente(e) {
            e.preventDefault();
            
            const cliente = {
                nome: document.getElementById('cliente-nome').value,
                cpf: document.getElementById('cliente-cpf').value,
                telefone: document.getElementById('cliente-telefone').value,
                email: document.getElementById('cliente-email').value,
                dataNascimento: document.getElementById('cliente-data-nascimento').value,
                grau: document.getElementById('cliente-grau').value,
                observacoes: document.getElementById('cliente-observacoes').value,
                dataCadastro: new Date().toISOString()
            };
            
            try {
                const transaction = db.transaction([STORES.CLIENTES], 'readwrite');
                const store = transaction.objectStore(STORES.CLIENTES);
                const request = store.add(cliente);
                
                request.onsuccess = function() {
                    alert('Cliente cadastrado com sucesso!');
                    closeClienteModal();
                    loadClientes();
                    loadClientesForSelect();
                    updateDashboard();
                    checkBirthdays();
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao cadastrar cliente:', event.target.error);
                    alert('Erro ao cadastrar cliente. Verifique os dados e tente novamente.');
                };
            } catch (error) {
                console.error('Erro na transação de cliente:', error);
                alert('Erro ao cadastrar cliente.');
            }
        }

        function editarCliente(id) {
            alert(`Editar cliente ${id} - Funcionalidade em desenvolvimento`);
        }

        function excluirCliente(id) {
            if (confirm('Tem certeza que deseja excluir este cliente?')) {
                try {
                    const transaction = db.transaction([STORES.CLIENTES], 'readwrite');
                    const store = transaction.objectStore(STORES.CLIENTES);
                    store.delete(id);
                    
                    transaction.oncomplete = function() {
                        loadClientes();
                        updateDashboard();
                        checkBirthdays();
                    };
                    
                    transaction.onerror = function(event) {
                        console.error('Erro ao excluir cliente:', event.target.error);
                        alert('Erro ao excluir cliente.');
                    };
                } catch (error) {
                    console.error('Erro na exclusão de cliente:', error);
                    alert('Erro ao excluir cliente.');
                }
            }
        }

        function enviarWhatsAppCliente(id) {
            try {
                const transaction = db.transaction([STORES.CLIENTES], 'readonly');
                const store = transaction.objectStore(STORES.CLIENTES);
                const request = store.get(id);
                
                request.onsuccess = function() {
                    const cliente = request.result;
                    const whatsappNumber = storeConfig.whatsappNumber || '5511999999999';
                    const message = `Olá ${cliente.nome}! Tudo bem? Aqui é da ${storeConfig.storeName}. Gostaríamos de entrar em contato para falar sobre nossos produtos e serviços.`;
                    const url = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
                    window.open(url, '_blank');
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao buscar cliente para WhatsApp:', event.target.error);
                    alert('Erro ao enviar mensagem.');
                };
            } catch (error) {
                console.error('Erro no envio de WhatsApp:', error);
                alert('Erro ao enviar mensagem.');
            }
        }

        // Funções para produtos
        function openProdutoModal() {
            const modal = document.getElementById('produto-modal');
            if (modal) {
                modal.classList.add('active');
            }
            const form = document.getElementById('form-produto');
            if (form) {
                form.reset();
            }
            const container = document.getElementById('product-image-upload-container');
            if (container) {
                container.innerHTML = `
                    <div class="product-image-placeholder">
                        <i class="fas fa-camera"></i>
                        <p>Clique para adicionar foto do produto</p>
                    </div>
                `;
            }
            const barcodePreview = document.getElementById('barcode-preview');
            if (barcodePreview) {
                barcodePreview.innerHTML = '';
            }
        }

        function closeProdutoModal() {
            const modal = document.getElementById('produto-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function handleProductImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const container = document.getElementById('product-image-upload-container');
                if (container) {
                    container.innerHTML = `<img src="${event.target.result}" alt="Imagem do produto">`;
                }
            };
            reader.readAsDataURL(file);
        }

        function generateBarcode() {
            const codigo = document.getElementById('produto-codigo').value || 'PROD' + Date.now();
            const barcodeContainer = document.getElementById('barcode-preview');
            
            if (codigo && barcodeContainer) {
                barcodeContainer.innerHTML = `<svg id="barcode"></svg>`;
                try {
                    JsBarcode("#barcode", codigo, {
                        format: "CODE128",
                        width: 2,
                        height: 50,
                        displayValue: true
                    });
                    
                    const codigoBarrasInput = document.getElementById('produto-codigo-barras');
                    if (codigoBarrasInput) {
                        codigoBarrasInput.value = codigo;
                    }
                } catch (error) {
                    console.error('Erro ao gerar código de barras:', error);
                    barcodeContainer.innerHTML = '<p style="color: red;">Erro ao gerar código de barras</p>';
                }
            }
        }

        function saveProduto(e) {
            e.preventDefault();
            
            // Obter imagem do produto
            const imgElement = document.querySelector('#product-image-upload-container img');
            const imagem = imgElement ? imgElement.src : '';
            
            const produto = {
                codigo: document.getElementById('produto-codigo').value,
                nome: document.getElementById('produto-nome').value,
                categoria: document.getElementById('produto-categoria').value,
                marca: document.getElementById('produto-marca').value,
                estoque: parseInt(document.getElementById('produto-estoque').value) || 0,
                estoqueMinimo: parseInt(document.getElementById('produto-estoque-minimo').value) || 5,
                precoCusto: parseFloat(document.getElementById('produto-preco-custo').value) || 0,
                precoVenda: parseFloat(document.getElementById('produto-preco-venda').value) || 0,
                codigoBarras: document.getElementById('produto-codigo-barras').value,
                descricao: document.getElementById('produto-descricao').value,
                imagem: imagem,
                dataCadastro: new Date().toISOString()
            };
            
            try {
                const transaction = db.transaction([STORES.PRODUTOS], 'readwrite');
                const store = transaction.objectStore(STORES.PRODUTOS);
                const request = store.add(produto);
                
                request.onsuccess = function() {
                    alert('Produto cadastrado com sucesso!');
                    closeProdutoModal();
                    loadProdutos();
                    loadProdutosForSelect();
                    checkLowStock();
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao cadastrar produto:', event.target.error);
                    if (event.target.error.name === 'ConstraintError') {
                        alert('Erro: Código ou código de barras já existe no sistema!');
                    } else {
                        alert('Erro ao cadastrar produto. Verifique os dados e tente novamente.');
                    }
                };
            } catch (error) {
                console.error('Erro na transação de produto:', error);
                alert('Erro ao cadastrar produto.');
            }
        }

        function editarProduto(id) {
            alert(`Editar produto ${id} - Funcionalidade em desenvolvimento`);
        }

        function excluirProduto(id) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                try {
                    const transaction = db.transaction([STORES.PRODUTOS], 'readwrite');
                    const store = transaction.objectStore(STORES.PRODUTOS);
                    store.delete(id);
                    
                    transaction.oncomplete = function() {
                        loadProdutos();
                        checkLowStock();
                    };
                    
                    transaction.onerror = function(event) {
                        console.error('Erro ao excluir produto:', event.target.error);
                        alert('Erro ao excluir produto.');
                    };
                } catch (error) {
                    console.error('Erro na exclusão de produto:', error);
                    alert('Erro ao excluir produto.');
                }
            }
        }

        function gerarCodigoBarras(id) {
            try {
                const transaction = db.transaction([STORES.PRODUTOS], 'readwrite');
                const store = transaction.objectStore(STORES.PRODUTOS);
                const request = store.get(id);
                
                request.onsuccess = function() {
                    const produto = request.result;
                    const codigo = produto.codigo || 'PROD' + produto.id;
                    
                    // Atualizar com código de barras
                    produto.codigoBarras = codigo;
                    const updateRequest = store.put(produto);
                    
                    updateRequest.onsuccess = function() {
                        alert(`Código de barras gerado: ${codigo}`);
                        loadProdutos();
                    };
                    
                    updateRequest.onerror = function(event) {
                        console.error('Erro ao gerar código de barras:', event.target.error);
                        alert('Erro ao gerar código de barras.');
                    };
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao buscar produto:', event.target.error);
                    alert('Erro ao gerar código de barras.');
                };
            } catch (error) {
                console.error('Erro na geração de código de barras:', error);
                alert('Erro ao gerar código de barras.');
            }
        }

        // Funções para vendas com múltiplas formas de pagamento
        function openVendaModal() {
            const modal = document.getElementById('venda-modal');
            if (modal) {
                modal.classList.add('active');
            }
            vendaItens = [];
            currentVendaId = null;
            paymentMethods = [];
            updateVendaItensTable();
            updateVendaTotals();
            updatePaymentMethods();
            
            const vendaData = document.getElementById('venda-data');
            if (vendaData) {
                vendaData.value = new Date().toISOString().split('T')[0];
            }
        }

        function closeVendaModal() {
            const modal = document.getElementById('venda-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function addProductToVenda() {
            const produtoSelect = document.getElementById('venda-produto');
            if (!produtoSelect) return;
            
            const selectedOption = produtoSelect.options[produtoSelect.selectedIndex];
            const produtoId = parseInt(produtoSelect.value);
            const quantidade = parseInt(document.getElementById('venda-quantidade').value) || 1;
            
            if (!produtoId || quantidade < 1) {
                alert('Selecione um produto e informe a quantidade');
                return;
            }
            
            try {
                const transaction = db.transaction([STORES.PRODUTOS], 'readonly');
                const store = transaction.objectStore(STORES.PRODUTOS);
                const request = store.get(produtoId);
                
                request.onsuccess = function() {
                    const produto = request.result;
                    
                    if (!produto) {
                        alert('Produto não encontrado!');
                        return;
                    }
                    
                    if (produto.estoque < quantidade) {
                        alert(`Estoque insuficiente! Disponível: ${produto.estoque}`);
                        return;
                    }
                    
                    // Adicionar à venda
                    const item = {
                        produtoId: produto.id,
                        codigo: produto.codigo,
                        nome: produto.nome,
                        quantidade: quantidade,
                        precoUnitario: produto.precoVenda,
                        desconto: 0,
                        subtotal: produto.precoVenda * quantidade
                    };
                    
                    vendaItens.push(item);
                    updateVendaItensTable();
                    updateVendaTotals();
                    
                    // Limpar seleção
                    produtoSelect.selectedIndex = 0;
                    const vendaQuantidade = document.getElementById('venda-quantidade');
                    if (vendaQuantidade) {
                        vendaQuantidade.value = 1;
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao buscar produto:', event.target.error);
                    alert('Erro ao adicionar produto.');
                };
            } catch (error) {
                console.error('Erro na adição de produto:', error);
                alert('Erro ao adicionar produto.');
            }
        }

        function updateVendaItensTable() {
            const tbody = document.getElementById('venda-itens-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            vendaItens.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.codigo} - ${item.nome}</td>
                    <td>${item.quantidade}</td>
                    <td>${formatCurrency(item.precoUnitario)}</td>
                    <td>${formatCurrency(item.desconto)}</td>
                    <td>${formatCurrency(item.subtotal)}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removerItemVenda(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function removerItemVenda(index) {
            vendaItens.splice(index, 1);
            updateVendaItensTable();
            updateVendaTotals();
        }

        function updateVendaTotals() {
            const subtotal = vendaItens.reduce((sum, item) => sum + item.subtotal, 0);
            const desconto = parseFloat(document.getElementById('venda-desconto-valor').value) || 0;
            const total = subtotal - desconto;
            
            const subtotalEl = document.getElementById('venda-subtotal');
            const descontoEl = document.getElementById('venda-desconto');
            const totalEl = document.getElementById('venda-total');
            
            if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal);
            if (descontoEl) descontoEl.textContent = formatCurrency(desconto);
            if (totalEl) totalEl.textContent = formatCurrency(total);
            
            updatePaymentTotals(total);
        }

        // Funções para múltiplas formas de pagamento
        function addPaymentMethod() {
            const paymentMethodsList = document.getElementById('payment-methods-list');
            if (!paymentMethodsList) return;
            
            const newMethod = {
                tipo: 'dinheiro',
                valor: 0,
                parcelas: 1
            };
            
            paymentMethods.push(newMethod);
            updatePaymentMethods();
        }

        function removePaymentMethod(index) {
            paymentMethods.splice(index, 1);
            updatePaymentMethods();
        }

        function updatePaymentMethods() {
            const paymentMethodsList = document.getElementById('payment-methods-list');
            if (!paymentMethodsList) return;
            
            paymentMethodsList.innerHTML = '';
            
            paymentMethods.forEach((method, index) => {
                const methodDiv = document.createElement('div');
                methodDiv.className = 'payment-method-item';
                methodDiv.innerHTML = `
                    <select class="payment-method-type" data-index="${index}" style="flex: 1;">
                        <option value="dinheiro" ${method.tipo === 'dinheiro' ? 'selected' : ''}>Dinheiro</option>
                        <option value="cartao_debito" ${method.tipo === 'cartao_debito' ? 'selected' : ''}>Cartão Débito</option>
                        <option value="cartao_credito" ${method.tipo === 'cartao_credito' ? 'selected' : ''}>Cartão Crédito</option>
                        <option value="pix" ${method.tipo === 'pix' ? 'selected' : ''}>PIX</option>
                        <option value="boleto" ${method.tipo === 'boleto' ? 'selected' : ''}>Boleto</option>
                        <option value="credito_loja" ${method.tipo === 'credito_loja' ? 'selected' : ''}>Crédito Loja</option>
                        <option value="parcelado" ${method.tipo === 'parcelado' ? 'selected' : ''}>Parcelado</option>
                    </select>
                    <input type="number" class="payment-method-value" data-index="${index}" placeholder="Valor" step="0.01" min="0" value="${method.valor || 0}" style="flex: 1;">
                    <select class="payment-method-parcelas" data-index="${index}" style="display: ${method.tipo === 'parcelado' ? 'block' : 'none'}; flex: 0.5;">
                        <option value="1" ${method.parcelas === 1 ? 'selected' : ''}>1x</option>
                        <option value="2" ${method.parcelas === 2 ? 'selected' : ''}>2x</option>
                        <option value="3" ${method.parcelas === 3 ? 'selected' : ''}>3x</option>
                        <option value="4" ${method.parcelas === 4 ? 'selected' : ''}>4x</option>
                        <option value="5" ${method.parcelas === 5 ? 'selected' : ''}>5x</option>
                        <option value="6" ${method.parcelas === 6 ? 'selected' : ''}>6x</option>
                    </select>
                    <button type="button" class="btn btn-sm btn-danger remove-payment-method" data-index="${index}"><i class="fas fa-times"></i></button>
                `;
                
                paymentMethodsList.appendChild(methodDiv);
                
                // Adicionar event listeners
                const typeSelect = methodDiv.querySelector('.payment-method-type');
                const valueInput = methodDiv.querySelector('.payment-method-value');
                const parcelasSelect = methodDiv.querySelector('.payment-method-parcelas');
                const removeBtn = methodDiv.querySelector('.remove-payment-method');
                
                typeSelect.addEventListener('change', function() {
                    const idx = parseInt(this.dataset.index);
                    paymentMethods[idx].tipo = this.value;
                    if (this.value === 'parcelado') {
                        parcelasSelect.style.display = 'block';
                    } else {
                        parcelasSelect.style.display = 'none';
                    }
                    updatePaymentTotals();
                });
                
                valueInput.addEventListener('input', function() {
                    const idx = parseInt(this.dataset.index);
                    paymentMethods[idx].valor = parseFloat(this.value) || 0;
                    updatePaymentTotals();
                });
                
                parcelasSelect.addEventListener('change', function() {
                    const idx = parseInt(this.dataset.index);
                    paymentMethods[idx].parcelas = parseInt(this.value);
                });
                
                removeBtn.addEventListener('click', function() {
                    const idx = parseInt(this.dataset.index);
                    removePaymentMethod(idx);
                });
            });
            
            updatePaymentTotals();
        }

        function updatePaymentTotals(totalVenda) {
            if (totalVenda === undefined) {
                const subtotal = vendaItens.reduce((sum, item) => sum + item.subtotal, 0);
                const desconto = parseFloat(document.getElementById('venda-desconto-valor').value) || 0;
                totalVenda = subtotal - desconto;
            }
            
            const totalPayment = paymentMethods.reduce((sum, method) => sum + (method.valor || 0), 0);
            const changeAmount = totalPayment - totalVenda;
            
            const totalPaymentEl = document.getElementById('total-payment');
            const changeAmountEl = document.getElementById('change-amount');
            
            if (totalPaymentEl) totalPaymentEl.textContent = formatCurrency(totalPayment);
            if (changeAmountEl) {
                changeAmountEl.textContent = formatCurrency(changeAmount);
                if (changeAmount >= 0) {
                    changeAmountEl.style.color = 'var(--success-color)';
                } else {
                    changeAmountEl.style.color = 'var(--accent-color)';
                }
            }
        }

        function gerarOrcamentoFromVenda() {
            if (vendaItens.length === 0) {
                alert('Adicione pelo menos um produto ao orçamento');
                return;
            }
            
            const clienteSelect = document.getElementById('venda-cliente');
            if (!clienteSelect) return;
            
            const clienteId = parseInt(clienteSelect.value);
            if (!clienteId) {
                alert('Selecione um cliente para o orçamento');
                return;
            }
            
            const subtotal = vendaItens.reduce((sum, item) => sum + item.subtotal, 0);
            const desconto = parseFloat(document.getElementById('venda-desconto-valor').value) || 0;
            const total = subtotal - desconto;
            
            const orcamento = {
                clienteId: clienteId,
                data: new Date().toISOString(),
                itens: vendaItens,
                subtotal: subtotal,
                desconto: desconto,
                valorTotal: total,
                status: 'Pendente',
                observacoes: document.getElementById('venda-observacoes').value
            };
            
            try {
                const transaction = db.transaction([STORES.ORCAMENTOS], 'readwrite');
                const store = transaction.objectStore(STORES.ORCAMENTOS);
                const request = store.add(orcamento);
                
                request.onsuccess = function() {
                    alert('Orçamento gerado com sucesso!');
                    closeVendaModal();
                    loadOrcamentos();
                    updateDashboard();
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao gerar orçamento:', event.target.error);
                    alert('Erro ao gerar orçamento.');
                };
            } catch (error) {
                console.error('Erro na geração de orçamento:', error);
                alert('Erro ao gerar orçamento.');
            }
        }

        function finalizarVenda() {
            if (vendaItens.length === 0) {
                alert('Adicione pelo menos um produto à venda');
                return;
            }
            
            const clienteSelect = document.getElementById('venda-cliente');
            const clienteId = clienteSelect ? parseInt(clienteSelect.value) : null;
            
            if (!clienteId) {
                if (!confirm('Deseja continuar a venda sem cliente cadastrado?')) {
                    return;
                }
            }
            
            // Verificar se há formas de pagamento
            if (paymentMethods.length === 0) {
                alert('Adicione pelo menos uma forma de pagamento');
                return;
            }
            
            // Verificar se o total dos pagamentos cobre o valor da venda
            const subtotal = vendaItens.reduce((sum, item) => sum + item.subtotal, 0);
            const desconto = parseFloat(document.getElementById('venda-desconto-valor').value) || 0;
            const total = subtotal - desconto;
            
            const totalPayment = paymentMethods.reduce((sum, method) => sum + (method.valor || 0), 0);
            
            if (totalPayment < total) {
                if (!confirm(`O total dos pagamentos (${formatCurrency(totalPayment)}) é menor que o valor da venda (${formatCurrency(total)}). Deseja continuar?`)) {
                    return;
                }
            }
            
            // Verificar estoque
            let estoqueInsuficiente = false;
            let produtoSemEstoque = null;
            
            for (const item of vendaItens) {
                try {
                    const transaction = db.transaction([STORES.PRODUTOS], 'readonly');
                    const store = transaction.objectStore(STORES.PRODUTOS);
                    const request = store.get(item.produtoId);
                    
                    request.onsuccess = function() {
                        const produto = request.result;
                        if (produto.estoque < item.quantidade) {
                            estoqueInsuficiente = true;
                            produtoSemEstoque = produto.nome;
                        }
                    };
                } catch (error) {
                    console.error('Erro ao verificar estoque:', error);
                }
            }
            
            if (estoqueInsuficiente && produtoSemEstoque) {
                alert(`Estoque insuficiente para ${produtoSemEstoque}!`);
                return;
            }
            
            const venda = {
                clienteId: clienteId || null,
                data: new Date().toISOString(),
                itens: vendaItens,
                subtotal: subtotal,
                desconto: desconto,
                valorTotal: total,
                formasPagamento: paymentMethods,
                status: 'Concluída',
                observacoes: document.getElementById('venda-observacoes').value
            };
            
            // Atualizar estoque e salvar venda em uma única transação
            try {
                const transaction = db.transaction([STORES.PRODUTOS, STORES.VENDAS], 'readwrite');
                const produtosStore = transaction.objectStore(STORES.PRODUTOS);
                const vendasStore = transaction.objectStore(STORES.VENDAS);
                
                // Atualizar estoque de cada produto
                vendaItens.forEach(item => {
                    const produtoRequest = produtosStore.get(item.produtoId);
                    
                    produtoRequest.onsuccess = function() {
                        const produto = produtoRequest.result;
                        produto.estoque -= item.quantidade;
                        produtosStore.put(produto);
                    };
                });
                
                // Salvar venda
                const request = vendasStore.add(venda);
                
                request.onsuccess = function(e) {
                    currentVendaId = e.target.result;
                    alert('Venda finalizada com sucesso!');
                    
                    // Gerar recibo
                    gerarRecibo(currentVendaId);
                    
                    closeVendaModal();
                    loadVendas();
                    loadProdutos();
                    updateDashboard();
                    checkLowStock();
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao finalizar venda:', event.target.error);
                    alert('Erro ao finalizar venda.');
                };
            } catch (error) {
                console.error('Erro na finalização da venda:', error);
                alert('Erro ao finalizar venda.');
            }
        }

        function imprimirRecibo() {
            if (!currentVendaId) {
                alert('Finalize a venda primeiro para imprimir o recibo');
                return;
            }
            gerarRecibo(currentVendaId);
        }

        function gerarRecibo(vendaId) {
            try {
                const transaction = db.transaction([STORES.VENDAS, STORES.CLIENTES], 'readonly');
                const vendasStore = transaction.objectStore(STORES.VENDAS);
                const clientesStore = transaction.objectStore(STORES.CLIENTES);
                const request = vendasStore.get(vendaId);
                
                request.onsuccess = function() {
                    const venda = request.result;
                    let clienteNome = 'Consumidor';
                    
                    if (venda.clienteId) {
                        const clienteRequest = clientesStore.get(venda.clienteId);
                        clienteRequest.onsuccess = function() {
                            const cliente = clienteRequest.result;
                            clienteNome = cliente ? cliente.nome : 'Consumidor';
                            fillReceipt(venda, clienteNome);
                        };
                        
                        clienteRequest.onerror = function(event) {
                            console.error('Erro ao buscar cliente:', event.target.error);
                            fillReceipt(venda, clienteNome);
                        };
                    } else {
                        fillReceipt(venda, clienteNome);
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao buscar venda:', event.target.error);
                    alert('Erro ao gerar recibo.');
                };
            } catch (error) {
                console.error('Erro na geração de recibo:', error);
                alert('Erro ao gerar recibo.');
            }
        }

        function fillReceipt(venda, clienteNome) {
            const receipt = document.getElementById('thermal-receipt');
            if (!receipt) return;
            
            // Preencher informações da loja
            const receiptStoreName = document.getElementById('receipt-store-name');
            const receiptStoreAddress = document.getElementById('receipt-store-address');
            const receiptStorePhone = document.getElementById('receipt-store-phone');
            const receiptStoreCnpj = document.getElementById('receipt-store-cnpj');
            
            if (receiptStoreName) receiptStoreName.textContent = storeConfig.storeName;
            if (receiptStoreAddress) receiptStoreAddress.textContent = storeConfig.storeAddress;
            if (receiptStorePhone) receiptStorePhone.textContent = storeConfig.storePhone;
            if (receiptStoreCnpj) {
                receiptStoreCnpj.textContent = storeConfig.storeCNPJ ? `CNPJ: ${storeConfig.storeCNPJ}` : '';
            }
            
            // Preencher informações da venda
            const receiptSaleId = document.getElementById('receipt-sale-id');
            const receiptDate = document.getElementById('receipt-date');
            const receiptCustomer = document.getElementById('receipt-customer');
            
            if (receiptSaleId) receiptSaleId.textContent = `Nº: ${venda.id.toString().padStart(6, '0')}`;
            if (receiptDate) receiptDate.textContent = `Data: ${new Date(venda.data).toLocaleString('pt-BR')}`;
            if (receiptCustomer) receiptCustomer.textContent = `Cliente: ${clienteNome}`;
            
            // Preencher itens
            const itemsContainer = document.getElementById('receipt-items');
            if (itemsContainer) {
                itemsContainer.innerHTML = '';
                
                venda.itens.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'receipt-item';
                    itemDiv.innerHTML = `
                        <div>${item.quantidade}x ${item.nome}</div>
                        <div>${formatCurrency(item.subtotal)}</div>
                    `;
                    itemsContainer.appendChild(itemDiv);
                });
            }
            
            // Preencher formas de pagamento
            let formasPagamentoText = 'Dinheiro';
            if (venda.formasPagamento && venda.formasPagamento.length > 0) {
                formasPagamentoText = venda.formasPagamento.map(fp => {
                    return `${formatPaymentMethod(fp.tipo)}: ${formatCurrency(fp.valor)}`;
                }).join(', ');
            } else if (venda.formaPagamento) {
                formasPagamentoText = formatPaymentMethod(venda.formaPagamento);
            }
            
            // Preencher totais
            const totalDiv = document.querySelector('.receipt-total');
            if (totalDiv) {
                totalDiv.innerHTML = `
                    <div>Subtotal: ${formatCurrency(venda.subtotal)}</div>
                    <div>Desconto: ${formatCurrency(venda.desconto)}</div>
                    <div>Total: ${formatCurrency(venda.valorTotal)}</div>
                    <div>Forma Pagto: ${formasPagamentoText}</div>
                `;
            }
            
            // Imprimir
            if (storeConfig.printerType === 'thermal') {
                printThermalReceipt();
            } else {
                printBrowserReceipt();
            }
        }

        function printThermalReceipt() {
            const receipt = document.getElementById('thermal-receipt');
            if (!receipt) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Recibo de Venda</title>
                    <style>
                        body {
                            font-family: 'Courier New', monospace;
                            font-size: 12px;
                            width: 80mm;
                            margin: 0;
                            padding: 10px;
                        }
                        .receipt-header {
                            text-align: center;
                            margin-bottom: 10px;
                            border-bottom: 1px dashed #000;
                            padding-bottom: 10px;
                        }
                        .receipt-items {
                            margin: 10px 0;
                        }
                        .receipt-item {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 5px;
                        }
                        .receipt-total {
                            border-top: 1px dashed #000;
                            padding-top: 10px;
                            margin-top: 10px;
                            font-weight: bold;
                        }
                        .receipt-footer {
                            text-align: center;
                            margin-top: 10px;
                        }
                    </style>
                </head>
                <body>
                    ${receipt.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function printBrowserReceipt() {
            const receipt = document.getElementById('thermal-receipt');
            if (!receipt) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Recibo de Venda</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 20px;
                        }
                        .receipt-header {
                            text-align: center;
                            margin-bottom: 20px;
                            border-bottom: 2px solid #000;
                            padding-bottom: 20px;
                        }
                        .receipt-info {
                            margin-bottom: 20px;
                        }
                        .receipt-items {
                            margin: 20px 0;
                        }
                        .receipt-item {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                            padding: 5px 0;
                            border-bottom: 1px solid #eee;
                        }
                        .receipt-total {
                            border-top: 2px solid #000;
                            padding-top: 20px;
                            margin-top: 20px;
                            font-weight: bold;
                            font-size: 1.2em;
                        }
                        .receipt-footer {
                            text-align: center;
                            margin-top: 30px;
                            color: #666;
                        }
                        @media print {
                            button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${receipt.innerHTML}
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="window.print()">Imprimir</button>
                        <button onclick="window.close()">Fechar</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Funções para WhatsApp
        function enviarWhatsAppOrcamento(orcamentoId) {
            try {
                const transaction = db.transaction([STORES.ORCAMENTOS, STORES.CLIENTES], 'readonly');
                const orcamentosStore = transaction.objectStore(STORES.ORCAMENTOS);
                const clientesStore = transaction.objectStore(STORES.CLIENTES);
                const request = orcamentosStore.get(orcamentoId);
                
                request.onsuccess = function() {
                    const orcamento = request.result;
                    
                    const clienteRequest = clientesStore.get(orcamento.clienteId);
                    clienteRequest.onsuccess = function() {
                        const cliente = clienteRequest.result;
                        const whatsappNumber = cliente.telefone.replace(/\D/g, '');
                        
                        let message = `*${storeConfig.storeName}*\n`;
                        message += `*Orçamento Nº ${orcamento.id}*\n\n`;
                        message += `Prezado(a) ${cliente.nome},\n\n`;
                        message += `Segue orçamento solicitado:\n\n`;
                        
                        orcamento.itens.forEach((item, index) => {
                            message += `${index + 1}. ${item.nome} - ${item.quantidade}x R$ ${item.precoUnitario.toFixed(2)}\n`;
                        });
                        
                        message += `\n*Subtotal:* R$ ${orcamento.subtotal.toFixed(2)}\n`;
                        message += `*Desconto:* R$ ${orcamento.desconto.toFixed(2)}\n`;
                        message += `*Total:* R$ ${orcamento.valorTotal.toFixed(2)}\n\n`;
                        message += `Validade: 7 dias\n`;
                        message += `Aceitamos diversas formas de pagamento!\n\n`;
                        message += `Aguardamos seu retorno!\n`;
                        message += `${storeConfig.storeName}\n`;
                        message += `${storeConfig.storePhone}`;
                        
                        const url = `https://wa.me/55${whatsappNumber}?text=${encodeURIComponent(message)}`;
                        window.open(url, '_blank');
                    };
                    
                    clienteRequest.onerror = function(event) {
                        console.error('Erro ao buscar cliente:', event.target.error);
                        alert('Erro ao enviar mensagem.');
                    };
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao buscar orçamento:', event.target.error);
                    alert('Erro ao enviar mensagem.');
                };
            } catch (error) {
                console.error('Erro no envio de WhatsApp:', error);
                alert('Erro ao enviar mensagem.');
            }
        }

        // Funções para backup
        function openBackupModal() {
            const modal = document.getElementById('backup-modal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeBackupModal() {
            const modal = document.getElementById('backup-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function exportBackupJSON() {
            const backup = {};
            
            try {
                const transaction = db.transaction(Object.values(STORES), 'readonly');
                
                Object.values(STORES).forEach(storeName => {
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    
                    request.onsuccess = function() {
                        backup[storeName] = request.result;
                        
                        // Quando todos os dados forem coletados
                        if (Object.keys(backup).length === Object.keys(STORES).length) {
                            backup.metadata = {
                                date: new Date().toISOString(),
                                dbName: DB_NAME,
                                version: DB_VERSION
                            };
                            
                            const dataStr = JSON.stringify(backup, null, 2);
                            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                            
                            const exportFileDefaultName = `backup_otica_${new Date().toISOString().split('T')[0]}.json`;
                            
                            const linkElement = document.createElement('a');
                            linkElement.setAttribute('href', dataUri);
                            linkElement.setAttribute('download', exportFileDefaultName);
                            linkElement.click();
                            
                            alert('Backup exportado com sucesso!');
                        }
                    };
                    
                    request.onerror = function(event) {
                        console.error(`Erro ao exportar ${storeName}:`, event.target.error);
                    };
                });
                
                transaction.onerror = function(event) {
                    console.error('Erro na transação de backup:', event.target.error);
                    alert('Erro ao exportar backup.');
                };
            } catch (error) {
                console.error('Erro na exportação de backup:', error);
                alert('Erro ao exportar backup.');
            }
        }

        function exportBackupCSV() {
            alert('Exportar CSV - Funcionalidade em desenvolvimento');
        }

        function restoreBackup() {
            const fileInput = document.getElementById('restore-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Selecione um arquivo de backup');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const backup = JSON.parse(event.target.result);
                    
                    if (confirm('Tem certeza que deseja restaurar este backup? Todos os dados atuais serão substituídos.')) {
                        restoreBackupData(backup);
                    }
                } catch (error) {
                    alert('Erro ao ler arquivo de backup: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function restoreBackupData(backup) {
            try {
                const transaction = db.transaction(Object.values(STORES), 'readwrite');
                
                Object.values(STORES).forEach(storeName => {
                    if (backup[storeName]) {
                        const store = transaction.objectStore(storeName);
                        store.clear();
                        
                        backup[storeName].forEach(item => {
                            store.add(item);
                        });
                    }
                });
                
                transaction.oncomplete = function() {
                    alert('Backup restaurado com sucesso!');
                    location.reload();
                };
                
                transaction.onerror = function(event) {
                    console.error('Erro ao restaurar backup:', event.target.error);
                    alert('Erro ao restaurar backup.');
                };
            } catch (error) {
                console.error('Erro na restauração de backup:', error);
                alert('Erro ao restaurar backup.');
            }
        }

        function clearAllData() {
            if (confirm('ATENÇÃO: Esta ação irá apagar TODOS os dados do sistema. Esta ação não pode ser desfeita. Tem certeza?')) {
                try {
                    const transaction = db.transaction(Object.values(STORES), 'readwrite');
                    
                    Object.values(STORES).forEach(storeName => {
                        const store = transaction.objectStore(storeName);
                        store.clear();
                    });
                    
                    transaction.oncomplete = function() {
                        alert('Todos os dados foram apagados. O sistema será reiniciado.');
                        location.reload();
                    };
                    
                    transaction.onerror = function(event) {
                        console.error('Erro ao limpar dados:', event.target.error);
                        alert('Erro ao limpar dados.');
                    };
                } catch (error) {
                    console.error('Erro na limpeza de dados:', error);
                    alert('Erro ao limpar dados.');
                }
            }
        }

        function createBackup() {
            exportBackupJSON();
        }

        // Funções para código de barras
        function openBarcodeScanner(context) {
            const modal = document.getElementById('barcode-modal');
            if (modal) {
                modal.classList.add('active');
            }
            const resultDiv = document.getElementById('barcode-result');
            if (resultDiv) {
                resultDiv.innerHTML = '';
            }
            const manualBarcode = document.getElementById('manual-barcode');
            if (manualBarcode) {
                manualBarcode.value = '';
            }
            
            // Iniciar câmera
            startCamera();
        }

        function closeBarcodeModal() {
            const modal = document.getElementById('barcode-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            stopCamera();
        }

        function startCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                const resultDiv = document.getElementById('barcode-result');
                if (resultDiv) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Seu navegador não suporta acesso à câmera. Use a entrada manual.
                        </div>
                    `;
                }
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(function(stream) {
                    const video = document.getElementById('barcode-video');
                    if (video) {
                        video.srcObject = stream;
                        video.play();
                    }
                })
                .catch(function(err) {
                    console.error('Erro ao acessar câmera:', err);
                    const resultDiv = document.getElementById('barcode-result');
                    if (resultDiv) {
                        resultDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                Não foi possível acessar a câmera. Use a entrada manual.
                            </div>
                        `;
                    }
                });
        }

        function stopCamera() {
            const video = document.getElementById('barcode-video');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        function searchProductByBarcode() {
            const manualBarcode = document.getElementById('manual-barcode');
            const barcode = manualBarcode ? manualBarcode.value.trim() : '';
            
            if (!barcode) {
                alert('Digite um código de barras');
                return;
            }
            
            try {
                const transaction = db.transaction([STORES.PRODUTOS], 'readonly');
                const store = transaction.objectStore(STORES.PRODUTOS);
                const index = store.index('codigoBarras');
                const request = index.get(barcode);
                
                request.onsuccess = function() {
                    const produto = request.result;
                    const resultDiv = document.getElementById('barcode-result');
                    
                    if (resultDiv) {
                        if (produto) {
                            resultDiv.innerHTML = `
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle"></i>
                                    <div>
                                        <strong>Produto encontrado:</strong> ${produto.nome}
                                        <br><small>Código: ${produto.codigo} | Preço: ${formatCurrency(produto.precoVenda)} | Estoque: ${produto.estoque}</small>
                                    </div>
                                    <button class="btn btn-sm btn-primary" onclick="addProductToVendaFromBarcode(${produto.id})">
                                        Adicionar à Venda
                                    </button>
                                </div>
                            `;
                        } else {
                            resultDiv.innerHTML = `
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Produto não encontrado para o código: ${barcode}
                                </div>
                            `;
                        }
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao buscar produto por código de barras:', event.target.error);
                    const resultDiv = document.getElementById('barcode-result');
                    if (resultDiv) {
                        resultDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle"></i>
                                Erro ao buscar produto.
                            </div>
                        `;
                    }
                };
            } catch (error) {
                console.error('Erro na busca por código de barras:', error);
                alert('Erro ao buscar produto.');
            }
        }

        function addProductToVendaFromBarcode(produtoId) {
            closeBarcodeModal();
            openVendaModal();
            
            // Selecionar o produto
            const produtoSelect = document.getElementById('venda-produto');
            if (produtoSelect) {
                for (let i = 0; i < produtoSelect.options.length; i++) {
                    if (parseInt(produtoSelect.options[i].value) === produtoId) {
                        produtoSelect.selectedIndex = i;
                        const vendaQuantidade = document.getElementById('venda-quantidade');
                        if (vendaQuantidade) {
                            vendaQuantidade.value = 1;
                        }
                        addProductToVenda();
                        break;
                    }
                }
            }
        }

        // Funções para configurações
        function saveConfigFromForm() {
            const configNome = document.getElementById('config-nome');
            const configSlogan = document.getElementById('config-slogan');
            const configCnpj = document.getElementById('config-cnpj');
            const configTelefone = document.getElementById('config-telefone');
            const configEmail = document.getElementById('config-email');
            const configEndereco = document.getElementById('config-endereco');
            const configTaxaJuros = document.getElementById('config-taxa-juros');
            const configDiasGarantia = document.getElementById('config-dias-garantia');
            const configImpressora = document.getElementById('config-impressora');
            const configWhatsapp = document.getElementById('config-whatsapp');
            const configBackupAuto = document.getElementById('config-backup-auto');
            const configBackupPath = document.getElementById('config-backup-path');
            
            if (configNome) storeConfig.storeName = configNome.value;
            if (configSlogan) storeConfig.storeSlogan = configSlogan.value;
            if (configCnpj) storeConfig.storeCNPJ = configCnpj.value;
            if (configTelefone) storeConfig.storePhone = configTelefone.value;
            if (configEmail) storeConfig.storeEmail = configEmail.value;
            if (configEndereco) storeConfig.storeAddress = configEndereco.value;
            if (configTaxaJuros) storeConfig.taxRate = parseFloat(configTaxaJuros.value) || 2.5;
            if (configDiasGarantia) storeConfig.warrantyDays = parseInt(configDiasGarantia.value) || 90;
            if (configImpressora) storeConfig.printerType = configImpressora.value;
            if (configWhatsapp) storeConfig.whatsappNumber = configWhatsapp.value;
            if (configBackupAuto) storeConfig.backupAuto = configBackupAuto.value;
            if (configBackupPath) storeConfig.backupPath = configBackupPath.value;
            
            saveConfig();
        }

        function handleLogoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                storeConfig.logo = event.target.result;
                const container = document.getElementById('logo-upload-container');
                if (container) {
                    container.innerHTML = `<img src="${event.target.result}" alt="Logo da Loja">`;
                }
            };
            reader.readAsDataURL(file);
        }

        // Funções para relatórios
        function toggleCustomDateRange() {
            const periodo = document.getElementById('relatorio-periodo');
            const customRange = document.getElementById('custom-date-range');
            
            if (periodo && customRange) {
                if (periodo.value === 'personalizado') {
                    customRange.style.display = 'flex';
                } else {
                    customRange.style.display = 'none';
                }
            }
        }

        function gerarRelatorioPersonalizado() {
            const tipo = document.getElementById('relatorio-tipo');
            const periodo = document.getElementById('relatorio-periodo');
            
            if (!tipo || !periodo) return;
            
            let dataInicio, dataFim;
            
            if (periodo.value === 'personalizado') {
                const dataInicioInput = document.getElementById('data-inicio');
                const dataFimInput = document.getElementById('data-fim');
                
                if (!dataInicioInput || !dataFimInput) return;
                
                dataInicio = dataInicioInput.value;
                dataFim = dataFimInput.value;
                
                if (!dataInicio || !dataFim) {
                    alert('Informe as datas inicial e final');
                    return;
                }
            } else {
                const hoje = new Date();
                switch(periodo.value) {
                    case 'hoje':
                        dataInicio = dataFim = hoje.toISOString().split('T')[0];
                        break;
                    case 'semana':
                        const primeiroDiaSemana = new Date(hoje);
                        primeiroDiaSemana.setDate(hoje.getDate() - hoje.getDay());
                        dataInicio = primeiroDiaSemana.toISOString().split('T')[0];
                        dataFim = hoje.toISOString().split('T')[0];
                        break;
                    case 'mes':
                        dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0];
                        dataFim = hoje.toISOString().split('T')[0];
                        break;
                    case 'trimestre':
                        const trimestre = Math.floor(hoje.getMonth() / 3);
                        dataInicio = new Date(hoje.getFullYear(), trimestre * 3, 1).toISOString().split('T')[0];
                        dataFim = hoje.toISOString().split('T')[0];
                        break;
                    case 'ano':
                        dataInicio = new Date(hoje.getFullYear(), 0, 1).toISOString().split('T')[0];
                        dataFim = hoje.toISOString().split('T')[0];
                        break;
                }
            }
            
            gerarRelatorio(tipo.value, dataInicio, dataFim);
        }

        function gerarRelatorio(tipo, dataInicio, dataFim) {
            switch(tipo) {
                case 'vendas':
                    gerarRelatorioVendas(dataInicio, dataFim);
                    break;
                case 'estoque':
                    gerarRelatorioEstoque();
                    break;
                case 'financeiro':
                    gerarRelatorioFinanceiro(dataInicio, dataFim);
                    break;
                case 'clientes':
                    gerarRelatorioClientes();
                    break;
                case 'produtos':
                    gerarRelatorioProdutosMaisVendidos(dataInicio, dataFim);
                    break;
            }
        }

        function gerarRelatorioVendas(dataInicio, dataFim) {
            try {
                const transaction = db.transaction([STORES.VENDAS, STORES.CLIENTES], 'readonly');
                const vendasStore = transaction.objectStore(STORES.VENDAS);
                const index = vendasStore.index('data');
                const range = IDBKeyRange.bound(dataInicio, dataFim);
                const request = index.openCursor(range);
                
                let html = `
                    <h2>Relatório de Vendas</h2>
                    <p>Período: ${new Date(dataInicio).toLocaleDateString('pt-BR')} à ${new Date(dataFim).toLocaleDateString('pt-BR')}</p>
                    <table border="1" style="width:100%; border-collapse:collapse;">
                        <tr>
                            <th>ID</th>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>Valor Total</th>
                            <th>Forma Pagamento</th>
                        </tr>
                `;
                
                let totalGeral = 0;
                
                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        const venda = cursor.value;
                        totalGeral += venda.valorTotal;
                        
                        // Buscar nome do cliente
                        const clientesStore = transaction.objectStore(STORES.CLIENTES);
                        let clienteNome = 'Não informado';
                        if (venda.clienteId) {
                            const clienteRequest = clientesStore.get(venda.clienteId);
                            clienteRequest.onsuccess = function() {
                                const cliente = clienteRequest.result;
                                clienteNome = cliente ? cliente.nome : 'Cliente não encontrado';
                            };
                        }
                        
                        // Formatar formas de pagamento
                        let formasPagamento = 'Não informado';
                        if (venda.formasPagamento && venda.formasPagamento.length > 0) {
                            formasPagamento = venda.formasPagamento.map(fp => {
                                return `${formatPaymentMethod(fp.tipo)}: ${formatCurrency(fp.valor)}`;
                            }).join(', ');
                        } else if (venda.formaPagamento) {
                            formasPagamento = formatPaymentMethod(venda.formaPagamento);
                        }
                        
                        html += `
                            <tr>
                                <td>${venda.id}</td>
                                <td>${new Date(venda.data).toLocaleDateString('pt-BR')}</td>
                                <td>${clienteNome}</td>
                                <td>${formatCurrency(venda.valorTotal)}</td>
                                <td>${formasPagamento}</td>
                            </tr>
                        `;
                        
                        cursor.continue();
                    } else {
                        html += `
                            <tr>
                                <td colspan="3" style="text-align:right; font-weight:bold;">Total Geral:</td>
                                <td colspan="2" style="font-weight:bold;">${formatCurrency(totalGeral)}</td>
                            </tr>
                        </table>`;
                        
                        openReportWindow(html, 'relatorio_vendas');
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao gerar relatório de vendas:', event.target.error);
                    alert('Erro ao gerar relatório de vendas.');
                };
            } catch (error) {
                console.error('Erro na geração de relatório de vendas:', error);
                alert('Erro ao gerar relatório de vendas.');
            }
        }

        function gerarRelatorioEstoque() {
            try {
                const transaction = db.transaction([STORES.PRODUTOS], 'readonly');
                const store = transaction.objectStore(STORES.PRODUTOS);
                const request = store.openCursor();
                
                let html = `
                    <h2>Relatório de Estoque</h2>
                    <p>Data: ${new Date().toLocaleDateString('pt-BR')}</p>
                    <table border="1" style="width:100%; border-collapse:collapse;">
                        <tr>
                            <th>Código</th>
                            <th>Produto</th>
                            <th>Categoria</th>
                            <th>Estoque</th>
                            <th>Estoque Mínimo</th>
                            <th>Status</th>
                            <th>Preço Venda</th>
                            <th>Valor Total</th>
                        </tr>
                `;
                
                let valorTotalEstoque = 0;
                
                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        const produto = cursor.value;
                        const valorProduto = produto.estoque * produto.precoVenda;
                        valorTotalEstoque += valorProduto;
                        
                        let status = 'Normal';
                        if (produto.estoqueMinimo && produto.estoque <= produto.estoqueMinimo) {
                            status = '<span style="color:red; font-weight:bold;">BAIXO</span>';
                        } else if (produto.estoque === 0) {
                            status = '<span style="color:red; font-weight:bold;">ESGOTADO</span>';
                        }
                        
                        html += `
                            <tr>
                                <td>${produto.codigo}</td>
                                <td>${produto.nome}</td>
                                <td>${formatarCategoria(produto.categoria)}</td>
                                <td>${produto.estoque}</td>
                                <td>${produto.estoqueMinimo || '-'}</td>
                                <td>${status}</td>
                                <td>${formatCurrency(produto.precoVenda)}</td>
                                <td>${formatCurrency(valorProduto)}</td>
                            </tr>
                        `;
                        
                        cursor.continue();
                    } else {
                        html += `
                            <tr>
                                <td colspan="7" style="text-align:right; font-weight:bold;">Valor Total em Estoque:</td>
                                <td style="font-weight:bold;">${formatCurrency(valorTotalEstoque)}</td>
                            </tr>
                        </table>`;
                        
                        openReportWindow(html, 'relatorio_estoque');
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao gerar relatório de estoque:', event.target.error);
                    alert('Erro ao gerar relatório de estoque.');
                };
            } catch (error) {
                console.error('Erro na geração de relatório de estoque:', error);
                alert('Erro ao gerar relatório de estoque.');
            }
        }

        function openReportWindow(html, title) {
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
                        .logo { max-height: 50px; }
                        @media print {
                            button { display: none; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div>
                            <h1>${storeConfig.storeName}</h1>
                            <p>${storeConfig.storeAddress} | ${storeConfig.storePhone}</p>
                        </div>
                        ${storeConfig.logo ? `<img src="${storeConfig.logo}" class="logo" alt="Logo">` : ''}
                    </div>
                    ${html}
                    <div class="no-print" style="margin-top: 20px;">
                        <button onclick="window.print()">Imprimir</button>
                        <button onclick="window.close()">Fechar</button>
                    </div>
                </body>
                </html>
            `);
            reportWindow.document.close();
        }

        // Funções restantes para completar o sistema
        function visualizarOrcamento(id) {
            alert(`Visualizar orçamento ${id} - Funcionalidade em desenvolvimento`);
        }

        function converterOrcamento(id) {
            if (confirm('Deseja converter este orçamento em venda?')) {
                alert(`Converter orçamento ${id} em venda - Funcionalidade em desenvolvimento`);
            }
        }

        function excluirOrcamento(id) {
            if (confirm('Tem certeza que deseja excluir este orçamento?')) {
                try {
                    const transaction = db.transaction([STORES.ORCAMENTOS], 'readwrite');
                    const store = transaction.objectStore(STORES.ORCAMENTOS);
                    store.delete(id);
                    
                    transaction.oncomplete = function() {
                        loadOrcamentos();
                        updateDashboard();
                    };
                    
                    transaction.onerror = function(event) {
                        console.error('Erro ao excluir orçamento:', event.target.error);
                        alert('Erro ao excluir orçamento.');
                    };
                } catch (error) {
                    console.error('Erro na exclusão de orçamento:', error);
                    alert('Erro ao excluir orçamento.');
                }
            }
        }

        function visualizarVenda(id) {
            alert(`Visualizar venda ${id} - Funcionalidade em desenvolvimento`);
        }

        function imprimirReciboVenda(id) {
            gerarRecibo(id);
        }

        function excluirVenda(id) {
            if (confirm('Tem certeza que deseja excluir esta venda?')) {
                try {
                    const transaction = db.transaction([STORES.VENDAS], 'readwrite');
                    const store = transaction.objectStore(STORES.VENDAS);
                    store.delete(id);
                    
                    transaction.oncomplete = function() {
                        loadVendas();
                        updateDashboard();
                    };
                    
                    transaction.onerror = function(event) {
                        console.error('Erro ao excluir venda:', event.target.error);
                        alert('Erro ao excluir venda.');
                    };
                } catch (error) {
                    console.error('Erro na exclusão de venda:', error);
                    alert('Erro ao excluir venda.');
                }
            }
        }

        function visualizarServico(id) {
            alert(`Visualizar serviço ${id} - Funcionalidade em desenvolvimento`);
        }

        function atualizarStatusServico(id) {
            if (confirm('Deseja atualizar o status deste serviço?')) {
                alert(`Atualizar status serviço ${id} - Funcionalidade em desenvolvimento`);
            }
        }

        // Funções de relatório adicionais
        function gerarRelatorioFinanceiro(dataInicio, dataFim) {
            alert(`Relatório financeiro ${dataInicio} à ${dataFim} - Funcionalidade em desenvolvimento`);
        }

        function gerarRelatorioClientes() {
            alert('Relatório de clientes - Funcionalidade em desenvolvimento');
        }

        function gerarRelatorioProdutosMaisVendidos(dataInicio, dataFim) {
            alert(`Relatório produtos mais vendidos ${dataInicio} à ${dataFim} - Funcionalidade em desenvolvimento`);
        }
    </script>
</body>
</html>